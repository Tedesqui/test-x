<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Acesso Ã  Ferramenta de CorreÃ§Ã£o com IA</title>
    <script src="https://sdk.mercadopago.com/js/v2"></script>
    <style>
        body, html { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: black; color: white; }
        .container { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 16px; height: 100vh; text-align: center; padding: 20px; box-sizing: border-box; }
        h2 { font-size: 1.8em; }
        p { font-size: 1.1em; line-height: 1.5; }
        #pay-btn { padding: 14px 22px; font-size: 18px; border-radius: 8px; border: none; background: #28a745; color: white; cursor: pointer; font-weight: bold; }
        #wallet_container { margin-top: 10px; width: 320px; max-width: 90%; }
        body.hidden { visibility: hidden; }
    </style>
</head>
<body class="hidden">

    <div class="container">
        <h2>ðŸ”’ Acesso Restrito Ã  Ferramenta de CorreÃ§Ã£o</h2>
        <p>Para usar a ferramenta por <strong>1 hora</strong>, faÃ§a o pagamento de <strong>R$ 1,00</strong>.</p>
        <button id="pay-btn">ðŸ’³ Pagar R$ 1,00 com Mercado Pago</button>
        <div id="wallet_container"></div>
        <p style="font-size:0.9em;color:#ccc;margin-top:8px">Pagamento seguro via cartÃ£o, PIX e boleto.</p>
    </div>

    <script>
        const PUBLIC_KEY = "APP_USR-e86d8ca0-976c-468a-96ca-7e556120f5eb";
        const MP_SERVER_CREATE = "/api/create-payment";
        const APP_PAGE = "app.html";

        // ===== LÃ“GICA DE ACESSO ATUALIZADA =====
        function getSessionId() {
            let sid = localStorage.getItem("mp_session_id");
            if (!sid) {
                sid = crypto.randomUUID();
                localStorage.setItem("mp_session_id", sid);
            }
            return sid;
        }

        function hasValidAccess() {
            const tokenString = localStorage.getItem('accessToken');
            if (!tokenString) return false;
            try {
                const token = JSON.parse(tokenString);
                return Date.now() < token.expiry;
            } catch (e) { return false; }
        }

        function setAccessAndRedirect() {
            const expiry = Date.now() + (60 * 60 * 1000);
            const data = { expiry: expiry, grantedAt: Date.now() };
            localStorage.setItem("accessToken", JSON.stringify(data));
            window.location.href = APP_PAGE;
        }

        // --- FLUXO PRINCIPAL ---
        if (hasValidAccess()) {
            window.location.href = APP_PAGE;
        } else {
            document.body.classList.remove('hidden');

            const params = new URLSearchParams(window.location.search);
            if (params.get("payment_status") === "success") {
                setAccessAndRedirect();
            }

            const mp = new MercadoPago(PUBLIC_KEY, { locale: 'pt-BR' });
            
            document.getElementById("pay-btn").addEventListener("click", async () => {
                const payBtn = document.getElementById("pay-btn");
                payBtn.disabled = true;
                payBtn.textContent = "Aguarde...";

                const sessionId = getSessionId();

                try {
                    const res = await fetch(MP_SERVER_CREATE, { 
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ sessionId }) // Envia a sessionId
                    });

                    if (!res.ok) throw new Error("Erro ao iniciar o processo de pagamento.");
                    
                    const data = await res.json();
                    
                    mp.checkout({
                        preference: { id: data.preferenceId },
                        autoOpen: true,
                        render: { container: '#wallet_container' }
                    });

                    // ===== VERIFICAÃ‡ÃƒO EM PARALELO (PARA PIX) - CORRIGIDO =====
                    let checkCount = 0;
                    const maxChecks = 900; // âœ… CORRIGIDO: Para por seguranÃ§a apÃ³s 60 minutos
                    const checkInterval = setInterval(async () => {
                        checkCount++;
                        if (document.getElementById('wallet_container').offsetParent === null || checkCount > maxChecks) {
                            clearInterval(checkInterval);
                            payBtn.disabled = false;
                            payBtn.textContent = "ðŸ’³ Pagar R$ 1,00 com Mercado Pago";
                            return;
                        }

                        try {
                            const r = await fetch(`/api/check-status?sessionId=${sessionId}`);
                            if (r.ok) {
                                const j = await r.json();
                                if (j.paid) {
                                    clearInterval(checkInterval);
                                    setAccessAndRedirect();
                                }
                            }
                        } catch (e) {
                            console.error("Erro na verificaÃ§Ã£o de status:", e);
                            clearInterval(checkInterval); // Para em caso de erro de rede
                        }
                    }, 4000); // Verifica a cada 4 segundos

                } catch (error) {
                    alert(error.message);
                    payBtn.disabled = false;
                    payBtn.textContent = "ðŸ’³ Pagar R$ 1,00 com Mercado Pago";
                }
            });
        }
    </script>
</body>
</html>
