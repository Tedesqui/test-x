<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title data-key="title">Corre√ß√£o de Prova com IA - Projeto de Jean Tedesqui</title>
    <script src="https://sdk.mercadopago.com/js/v2"></script>
    <style>
        /* CSS completo aqui... (omitido para brevidade) */
        body, html { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: black; color: white; overflow: hidden; }
        #payment-screen { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 16px; height: 100vh; text-align: center; }
        #pay-btn { padding: 14px 22px; font-size: 18px; border-radius: 8px; border: none; background: #28a745; color: white; cursor: pointer; }
        #wallet_container { margin-top: 10px; width: 320px; max-width: 90%; }
        #main-app { display: none; height: 100vh; }
        video, canvas { position: absolute; top: 0; left: 0; width: 100vw; height: 100vh; object-fit: cover; z-index: 0; }
        canvas { display: none; }
        #ui-container { position: fixed; bottom: 0; left: 0; width: 100%; z-index: 2; }
        #controls { display: flex; gap: 15px; justify-content: center; align-items: center; padding: 20px; background: linear-gradient(to top, rgba(0,0,0,0.7), rgba(0,0,0,0)); }
        button { padding: 12px 20px; font-size: 16px; font-weight: bold; background-color: #007bff; color: white; border: none; border-radius: 8px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
        button:hover:not(:disabled) { background-color: #0056b3; transform: translateY(-2px); }
        button:disabled { background: #555; cursor: not-allowed; opacity: 0.7; }
        #output-panel { background: rgba(0,0,0,0.9); padding: 15px; max-height: 85vh; overflow-y: auto; box-sizing: border-box; border-top: 1px solid #444; }
        #confirmation-view { display: flex; flex-direction: column; gap: 15px; }
        #confirmation-view p { margin: 0; font-size: 0.9em; color: #ccc; }
        textarea { width: 100%; min-height: 120px; background: #2a2a2a; border: 1px solid #444; border-radius: 6px; color: white; font-size: 1em; padding: 10px; box-sizing: border-box; resize: vertical; }
        textarea:focus { outline: none; border-color: #007bff; }
        #confirmation-controls { display: flex; gap: 10px; justify-content: flex-end; }
        #confirmation-controls button.confirm { background-color: #28a745; }
        #confirmation-controls button.secondary { background-color: #6c757d; }
        pre#correction-result { background-color: #2a2a2a; padding: 1rem; border-radius: 6px; white-space: pre-wrap; word-wrap: break-word; line-height: 1.6; }
    </style>
</head>
<body>
    <div id="payment-screen" aria-live="polite">
      <h2>üîí Acesso Restrito</h2>
      <p>Para usar este site por <strong>1 hora</strong>, fa√ßa o pagamento de <strong>R$ 4,90</strong>.</p>
      <button id="pay-btn">üí≥ Pagar R$ 4,90</button>
      <div id="wallet_container"></div>
      <p style="font-size:0.9em;color:#ccc;margin-top:8px">Pagamento seguro ‚Äî cart√£o, PIX e boleto.</p>
    </div>
    <div id="main-app" aria-hidden="true">
        <video id="video" autoplay playsinline muted></video>
        <canvas id="canvas"></canvas>
        <div id="ui-container">
            <div id="controls">
                <button id="zoomBtn">üîç Zoom: 1x</button>
                <button id="captureBtn" data-key="capture_button">üì∑ Clique para Corrigir</button>
            </div>
            <div id="output-panel">
                <div id="status-text" data-key="status_initial">üì∑ Aponte a c√¢mera para o texto e capture.</div>
            </div>
        </div>
    </div>
    
    <script>
        const PUBLIC_KEY = "APP_USR-e86d8ca0-976c-468a-96ca-7e556120f5eb";
        const MP_SERVER_CREATE = "/api/create-payment";
        const mp = new MercadoPago(PUBLIC_KEY, { locale: 'pt-BR' });
        function getSessionId() { let sid = sessionStorage.getItem("mp_session_id"); if (!sid) { sid = crypto.randomUUID(); sessionStorage.setItem("mp_session_id", sid); } return sid; }
        function setAccess(expiryMillis) { const data = { expiry: expiryMillis, grantedAt: Date.now() }; sessionStorage.setItem("accessToken", JSON.stringify(data)); }
        function hasAccess() { const t = sessionStorage.getItem("accessToken"); if (!t) return false; try { const obj = JSON.parse(t); return Date.now() < obj.expiry; } catch(e) { return false; } }

        function showMainApp() {
            // PONTO DE VERIFICA√á√ÉO 1
            console.log("--- DEBUG: Fun√ß√£o showMainApp() foi chamada. ---");
            // alert("DEBUG: Ponto 1 - showMainApp foi chamada.");

            document.getElementById("payment-screen").style.display = "none";
            document.getElementById("main-app").style.display = "block";
            document.getElementById("main-app").ariaHidden = "false";
            try {
                if (typeof window.afterPaymentUnlocked === 'function' && !window.appInitialized) {
                    // PONTO DE VERIFICA√á√ÉO 2
                    console.log("--- DEBUG: Prepara-se para chamar afterPaymentUnlocked(). ---");
                    // alert("DEBUG: Ponto 2 - Preparando para iniciar a aplica√ß√£o.");
                    
                    window.afterPaymentUnlocked();
                    window.appInitialized = true;
                }
            } catch(e){
                console.error("--- DEBUG: Erro CR√çTICO ao chamar afterPaymentUnlocked ---", e);
                alert(`ERRO CR√çTICO ao chamar a aplica√ß√£o: ${e.message}`);
            }
        }

        window.addEventListener("keydown", (e) => { if ((e.key === "F5") || ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === "r")) { e.preventDefault(); alert("Recarregamento bloqueado. Feche a aba para encerrar a sess√£o."); } });
        if (hasAccess()) { showMainApp(); } else { const params = new URLSearchParams(window.location.search); if (params.get("status") === "success") { const expiry = Date.now() + (60 * 60 * 1000); setAccess(expiry); history.replaceState({}, "", location.pathname); showMainApp(); } }
        document.getElementById("pay-btn").addEventListener("click", async () => { const sessionId = getSessionId(); try { const res = await fetch(MP_SERVER_CREATE, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ sessionId }) }); if (!res.ok) throw new Error("Erro ao iniciar pagamento"); const data = await res.json(); mp.checkout({ preference: { id: data.preferenceId }, autoOpen: true, render: { container: '#wallet_container', label: 'Pagar' } }); const checkInterval = setInterval(async () => { try { const r = await fetch('/api/check-status?sessionId=' + encodeURIComponent(sessionId)); if (r.ok) { const j = await r.json(); if (j.paid) { clearInterval(checkInterval); const expiry = Date.now() + (60 * 60 * 1000); setAccess(expiry); document.getElementById('wallet_container').innerHTML = ''; showMainApp(); } } } catch(e){ console.error("Erro na verifica√ß√£o de status:", e); } }, 3000); } catch (error) { alert(error.message); } });
    </script>
    
    <script>
    window.afterPaymentUnlocked = function(){
        // PONTO DE VERIFICA√á√ÉO 3
        console.log("--- DEBUG: Fun√ß√£o afterPaymentUnlocked() INICIOU. ---");
        alert("DEBUG: Ponto 3 - Aplica√ß√£o iniciada! Pr√≥ximo passo: c√¢mera.");

        // ... (c√≥digo de setup de vari√°veis)
        const video = document.getElementById("video");
        const canvas = document.getElementById("canvas");
        const translations = { "pt": { "status_error_camera": "‚ùå Erro ao acessar a c√¢mera.", /* ... outras tradu√ß√µes */ } };
        let currentLang = 'pt';
        const outputPanel = document.getElementById("output-panel");

        async function startCamera() {
            // PONTO DE VERIFICA√á√ÉO 4
            console.log("--- DEBUG: Dentro de startCamera(). Tentando acessar navigator.mediaDevices. ---");
            alert("DEBUG: Ponto 4 - Tentando ligar a c√¢mera AGORA.");

            try {
                const constraints = { video: true };
                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = stream;
                
                // PONTO DE VERIFICA√á√ÉO 5 (SUCESSO)
                console.log("--- DEBUG: SUCESSO! C√¢mera ligada e stream obtido. ---");
                alert("DEBUG: Ponto 5 - SUCESSO! A c√¢mera deve estar funcionando.");

            } catch (err) {
                // PONTO DE VERIFICA√á√ÉO 6 (ERRO)
                console.error("--- DEBUG: ERRO CAPTURADO em startCamera() ---", err.name, err.message);
                alert(`DEBUG: Ponto 6 - ERRO NA C√ÇMERA!\n\nNome: ${err.name}\nMensagem: ${err.message}`);
                
                let userMessage = translations[currentLang].status_error_camera;
                outputPanel.innerHTML = `<div id="status-text">${userMessage}<br><small>${err.name}</small></div>`;
            }
        }
        
        // ... (resto do c√≥digo da aplica√ß√£o)
        function setLanguage(lang) { /* ... */ }
        function toggleZoom() { /* ... */ }
        // ... etc ...

        // In√≠cio da execu√ß√£o
        setLanguage(navigator.language || navigator.userLanguage);
        startCamera();
    };
    </script>
</body>
</html>
