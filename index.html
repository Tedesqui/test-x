<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pagamento - Acesso à Ferramenta</title>
    <script src="https://sdk.mercadopago.com/js/v2"></script>
    <style>
        body, html { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: black; color: white; }
        .container { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; text-align: center; padding: 20px; box-sizing: border-box; }
        h2 { font-size: 1.8em; margin-bottom: 8px; }
        p { font-size: 1.1em; line-height: 1.5; max-width: 450px; }
        body.hidden { visibility: hidden; }

        /* Estilos para as abas de pagamento */
        .tabs { display: flex; border-bottom: 1px solid #444; margin-bottom: 20px; margin-top: 15px; }
        .tab-button { background: none; border: none; color: #aaa; padding: 10px 18px; cursor: pointer; font-size: 1em; border-bottom: 2px solid transparent; }
        .tab-button.active { color: white; border-bottom: 2px solid #009ee3; }
        .tab-content { display: none; width: 100%; max-width: 380px; }
        .tab-content.active { display: block; }
        
        #feedback-container { font-size: 1em; color: #ccc; margin-top: 20px; height: 20px; }
    </style>
</head>
<body class="hidden">

    <div class="container">
        <h2>🔒 Acesso Restrito à Ferramenta de Correção</h2>
        <p>Para usar a ferramenta por <strong>1 hora</strong>, faça o pagamento de <strong>R$ 1,00</strong>.</p>

        <div class="tabs">
            <button class="tab-button active" data-tab="card">💳 Cartão de Crédito</button>
            <button class="tab-button" data-tab="pix">Pix</button>
        </div>

        <div id="card" class="tab-content active">
            <div id="card-payment-container"></div>
        </div>
        <div id="pix" class="tab-content">
            <div id="pix-payment-container"></div>
        </div>

        <div id="feedback-container">Carregando...</div>
    </div>

    <script>
        const PUBLIC_KEY = "APP_USR-e86d8ca0-976c-468a-96ca-7e556120f5eb";
        const MP_SERVER_CREATE = "/api/create-payment";
        const MP_SERVER_PROCESS_CARD = "/api/process-card-payment"; // <-- NOVO ENDPOINT NECESSÁRIO NO SEU BACKEND
        const MP_SERVER_CHECK_STATUS = "/api/check-status";
        const APP_PAGE = "app.html";

        // ===== LÓGICA DE SESSÃO E ACESSO (Inalterada) =====
        function getSessionId() {
            let sid = localStorage.getItem("mp_session_id");
            if (!sid) {
                sid = crypto.randomUUID();
                localStorage.setItem("mp_session_id", sid);
            }
            return sid;
        }

        function hasValidAccess() {
            const tokenString = localStorage.getItem('accessToken');
            if (!tokenString) return false;
            try {
                const token = JSON.parse(tokenString);
                return Date.now() < token.expiry;
            } catch (e) { return false; }
        }

        function setAccessAndRedirect() {
            const expiry = Date.now() + (60 * 60 * 1000);
            const data = { expiry: expiry, grantedAt: Date.now() };
            localStorage.setItem("accessToken", JSON.stringify(data));
            window.location.href = APP_PAGE;
        }
        
        // ===== NOVO FLUXO DE PAGAMENTO COM BRICKS =====
        const mp = new MercadoPago(PUBLIC_KEY, { locale: 'pt-BR' });
        const bricks = mp.bricks();
        let pixStatusInterval;

        const feedbackContainer = document.getElementById('feedback-container');

        // Função para lidar com o sucesso do pagamento e liberar o acesso
        function handlePaymentSuccess() {
            if (pixStatusInterval) clearInterval(pixStatusInterval);
            feedbackContainer.textContent = "✅ Pagamento aprovado! Redirecionando...";
            setTimeout(setAccessAndRedirect, 1500);
        }

        // 1. Renderiza o Brick de Cartão de Crédito
        async function renderCardBrick() {
            const settings = {
                initialization: {
                    amount: 1.00, // Valor do pagamento
                },
                customization: {
                    visual: { style: { theme: 'dark' } },
                    paymentMethods: {
                        creditCard: 'all',
                        debitCard: [], // Desabilita cartão de débito
                        mercadoPago: [], // Desabilita opção de pagar com a conta Mercado Pago
                    },
                },
                callbacks: {
                    onSubmit: async (cardFormData) => {
                        feedbackContainer.textContent = "Processando pagamento...";
                        try {
                            const res = await fetch(MP_SERVER_PROCESS_CARD, {
                                method: "POST",
                                headers: { "Content-Type": "application/json" },
                                body: JSON.stringify({ ...cardFormData, sessionId: getSessionId() }),
                            });
                            const data = await res.json();
                            if (!res.ok) throw new Error(data.message || "Erro no pagamento.");
                            if (data.status === 'approved') {
                                handlePaymentSuccess();
                            } else {
                                alert('Pagamento não aprovado. Verifique os dados ou tente outra forma de pagamento.');
                                feedbackContainer.textContent = "Pagamento recusado.";
                            }
                        } catch (error) {
                            alert(error.message);
                            feedbackContainer.textContent = "Escolha como deseja pagar.";
                        }
                    },
                    onError: (error) => console.error(error),
                },
            };
            return bricks.create('cardPayment', 'card-payment-container', settings);
        }

        // 2. Renderiza o Brick do Pix
        async function renderPixBrick(preferenceId) {
            const settings = {
                initialization: { preferenceId: preferenceId },
                customization: { visual: { qrCodeSize: '220' } },
                callbacks: {
                    onReady: () => {
                        // Inicia a verificação de status do Pix em segundo plano
                        const sessionId = getSessionId();
                        pixStatusInterval = setInterval(async () => {
                            try {
                                const r = await fetch(`${MP_SERVER_CHECK_STATUS}?sessionId=${sessionId}`);
                                if (r.ok) {
                                    const j = await r.json();
                                    if (j.paid) handlePaymentSuccess();
                                }
                            } catch (e) {
                                console.error("Erro na verificação de status:", e);
                                clearInterval(pixStatusInterval);
                            }
                        }, 4000); // Verifica a cada 4 segundos
                    },
                    onError: (error) => console.error(error),
                },
            };
            return bricks.create('pix', 'pix-payment-container', settings);
        }

        // 3. Função Principal que orquestra a página
        async function main() {
            if (hasValidAccess()) {
                window.location.href = APP_PAGE;
                return;
            }

            document.body.classList.remove('hidden');

            const params = new URLSearchParams(window.location.search);
            if (params.get("payment_status") === "success") {
                setAccessAndRedirect();
                return;
            }
            
            // Configura a troca de abas
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', () => {
                    document.querySelectorAll('.tab-button, .tab-content').forEach(el => el.classList.remove('active'));
                    button.classList.add('active');
                    document.getElementById(button.dataset.tab).classList.add('active');
                });
            });

            // Inicia o processo de pagamento
            try {
                const res = await fetch(MP_SERVER_CREATE, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ sessionId: getSessionId() })
                });
                if (!res.ok) throw new Error("Não foi possível iniciar o pagamento.");
                const data = await res.json();
                
                // Renderiza os dois bricks
                await Promise.all([
                    renderCardBrick(),
                    renderPixBrick(data.preferenceId)
                ]);
                
                feedbackContainer.textContent = 'Escolha como deseja pagar.';
            } catch (error) {
                feedbackContainer.textContent = `Erro: ${error.message}`;
                console.error(error);
            }
        }

        main();
    </script>
</body>
</html>
