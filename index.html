<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="pageTitle">Receba as respostas das questões da sua prova!!!</title>
    <style>
        body, html { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: #121212; color: white; }
        .hidden-on-load { visibility: hidden; }
        .container { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; text-align: center; padding: 20px; box-sizing: border-box; }
        .view { display: none; flex-direction: column; align-items: center; width: 100%; max-width: 420px; margin-top: -250px; }
        .view.active { display: flex; }
        #start-btn { width: 100%; color: white; font-weight: bold; font-size: 18px; padding: 0.75rem 1rem; border: none; border-radius: 0.5rem; cursor: pointer; transition: background-color 0.2s; margin-top: 1.5rem; background-color: #22c55e; }
        #start-btn:hover:not(:disabled) { background-color: #16a34a; }
        #start-btn:disabled { background-color: #555; cursor: wait; }
    </style>
</head>
<body class="hidden-on-load">
    <div class="container">
        <div id="welcome-view" class="view active">
            <h2 data-i18n="headline">🔒 Acesso por 1 Semana à Correção de Provas</h2>
            <p data-i18n="subheadline" style="font-size: 1.1em; line-height: 1.5;">Realize o pagamento de <strong data-i18n="price">R$ 14,90</strong> para liberar o acesso...</p>
            <button id="start-btn" data-i18n="paymentButton">CLIQUE AQUI PARA PAGAR</button>
        </div>
    </div>

    <script>
        // --- DICIONÁRIO DE TRADUÇÕES (i18n) EXPANDIDO ---
        const translations = {
            "pt-br": { pageTitle: "Receba as respostas das questões da sua prova!!!", headline: "🔒 Acesso por 1 Semana à Correção de Provas", subheadline: 'Realize o pagamento de <strong>{price}</strong> para liberar o acesso. Após o pagamento, retorne e dê permissão para o site usar sua câmera. Aponte para as questões, clique em <strong>{captureAction}</strong> e em seguida em <strong>{answerAction}</strong>.', price: 'R$ 14,90', captureAction: '“Clique para Corrigir”', answerAction: '“Obter Resposta”', paymentButton: "CLIQUE AQUI PARA PAGAR", loadingCheckout: "Aguarde, gerando checkout...", checkoutError: "Erro ao gerar link de pagamento.", paymentCheck: "Verificando seu pagamento, aguarde um instante...", paymentCheckError: "Ocorreu um problema ao verificar seu pagamento. Por favor, recarregue a página." },
            "en": { pageTitle: "Get Answers for Your Test Questions!", headline: "🔒 1-Week Access to AI Proofreader", subheadline: 'Make the payment of <strong>{price}</strong> to unlock access. After payment, return to the site and grant camera permission. Point the camera at the questions, click on <strong>{captureAction}</strong> and then on <strong>{answerAction}</strong>.', price: '$3.00 USD', captureAction: '“Click to Correct”', answerAction: '“Get Answer”', paymentButton: "CLICK HERE TO PAY", loadingCheckout: "Please wait, generating checkout...", checkoutError: "Error generating payment link.", paymentCheck: "Verifying your payment, please wait a moment...", paymentCheckError: "There was a problem verifying your payment. Please reload the page." },
            "es": { pageTitle: "¡Reciba las respuestas de las preguntas de su examen!", headline: "🔒 Acceso de 1 Semana al Corrector de Pruebas IA", subheadline: 'Realice el pago de <strong>{price}</strong> para desbloquear el acceso. Después del pago, regrese al sitio y conceda permiso para la cámara. Apunte la cámara a las preguntas, haga clic en <strong>{captureAction}</strong> y luego en <strong>{answerAction}</strong>.', price: '$3.00 USD', captureAction: '“Haga Clic para Corregir”', answerAction: '“Obtener Respuesta”', paymentButton: "HAGA CLIC AQUÍ PARA PAGAR", loadingCheckout: "Espere, generando checkout...", checkoutError: "Error al generar el enlace de pago.", paymentCheck: "Verificando su pago, espere un momento...", paymentCheckError: "Hubo un problema al verificar su pago. Por favor, recargue la página." },
            "it": { pageTitle: "Ottieni le risposte alle domande del tuo esame!", headline: "🔒 Accesso di 1 settimana al Correttore di Bozze AI", subheadline: 'Effettua il pagamento di <strong>{price}</strong> per sbloccare l\'accesso. Dopo il pagamento, torna al sito e concedi il permesso per la fotocamera. Punta la fotocamera sulle domande, fai clic su <strong>{captureAction}</strong> e poi su <strong>{answerAction}</strong>.', price: '$3.00 USD', captureAction: '“Clicca per Correggere”', answerAction: '“Ottieni Risposta”', paymentButton: "CLICCA QUI PER PAGARE", loadingCheckout: "Attendere, generazione checkout in corso...", checkoutError: "Errore nella generazione del link di pagamento.", paymentCheck: "Verifica del pagamento in corso, attendere prego...", paymentCheckError: "Si è verificato un problema durante la verifica del pagamento. Si prega di ricaricare la pagina." },
            "fr": { pageTitle: "Obtenez les réponses à vos questions d'examen!", headline: "🔒 Accès d'une semaine au correcteur IA", subheadline: 'Effectuez le paiement de <strong>{price}</strong> pour débloquer l\'accès. Après le paiement, revenez sur le site et autorisez l\'accès à la caméra. Pointez la caméra sur les questions, cliquez sur <strong>{captureAction}</strong>, puis sur <strong>{answerAction}</strong>.', price: '$3.00 USD', captureAction: '« Cliquer pour Corriger »', answerAction: '« Obtenir la Réponse »', paymentButton: "CLIQUEZ ICI POUR PAYER", loadingCheckout: "Veuillez patienter, génération du paiement en cours...", checkoutError: "Erreur lors de la génération du lien de paiement.", paymentCheck: "Vérification de votre paiement, veuillez patienter un instant...", paymentCheckError: "Un problème est survenu lors de la vérification de votre paiement. Veuillez recharger la page." },
            "ru": { pageTitle: "Получите ответы на вопросы вашего теста!", headline: "🔒 Доступ на 1 неделю к ИИ-корректору", subheadline: 'Произведите оплату в размере <strong>{price}</strong>, чтобы разблокировать доступ. После оплаты вернитесь на сайт и предоставьте разрешение для камеры. Наведите камеру на вопросы, нажмите <strong>{captureAction}</strong>, а затем <strong>{answerAction}</strong>.', price: '$3.00 USD', captureAction: '«Нажмите, чтобы исправить»', answerAction: '«Получить ответ»', paymentButton: "НАЖМИТЕ ЗДЕСЬ, ЧТОБЫ ОПЛАТИТЬ", loadingCheckout: "Пожалуйста, подождите, генерируется ссылка на оплату...", checkoutError: "Ошибка при создании ссылки на оплату.", paymentCheck: "Проверяем ваш платеж, пожалуйста, подождите...", paymentCheckError: "Возникла проблема при проверке вашего платежа. Пожалуйста, перезагрузите страницу." },
            "ja": { pageTitle: "テスト問題の答えを手に入れよう！", headline: "🔒 AI校正ツールへの1週間アクセス", subheadline: '<strong>{price}</strong> のお支払いでアクセスを解除します。支払い後、サイトに戻り、カメラへのアクセスを許可してください。質問にカメラを向け、<strong>{captureAction}</strong> をクリックし、次に <strong>{answerAction}</strong> をクリックします。', price: '$3.00 USD', captureAction: '「クリックして修正」', answerAction: '「回答を得る」', paymentButton: "ここをクリックして支払う", loadingCheckout: "お待ちください、チェックアウトを生成中です...", checkoutError: "支払いリンクの生成中にエラーが発生しました。", paymentCheck: "お支払いを確認しています、しばらくお待ちください...", paymentCheckError: "お支払いの確認中に問題が発生しました。ページを再読み込みしてください。" },
            "ko": { pageTitle: "시험 문제의 답을 얻으세요!", headline: "🔒 AI 교정기 1주일 이용권", subheadline: '<strong>{price}</strong>를 결제하여 액세스를 잠금 해제하세요. 결제 후 사이트로 돌아와 카메라 권한을 허용해 주세요. 질문에 카메라를 맞추고 <strong>{captureAction}</strong>을 클릭한 다음 <strong>{answerAction}</strong>을 클릭하세요.', price: '$3.00 USD', captureAction: '“클릭하여 수정”', answerAction: '“답변 얻기”', paymentButton: "결제하려면 여기를 클릭하세요", loadingCheckout: "잠시만 기다려주세요, 결제 창을 생성 중입니다...", checkoutError: "결제 링크 생성 중 오류가 발생했습니다.", paymentCheck: "결제를 확인 중입니다, 잠시만 기다려주세요...", paymentCheckError: "결제 확인 중 문제가 발생했습니다. 페이지를 새로고침해 주세요." },
            "zh": { pageTitle: "获取您的测试题答案！", headline: "🔒 人工智能校对器1周使用权", subheadline: '支付<strong>{price}</strong>以解锁访问权限。支付后，返回网站并授予相机权限。将相机对准问题，点击<strong>{captureAction}</strong>，然后点击<strong>{answerAction}</strong>。', price: '$3.00 USD', captureAction: '“点击以更正”', answerAction: '“获取答案”', paymentButton: "点击此处付款", loadingCheckout: "请稍候，正在生成结账...", checkoutError: "生成支付链接时出错。", paymentCheck: "正在验证您的付款，请稍等...", paymentCheckError: "验证您的付款时出现问题。请重新加载页面。" }
        };

        // --- FUNÇÃO DE TRADUÇÃO MELHORADA ---
        function getLanguage(supportedLangs) {
            const userLang = (navigator.language || navigator.userLanguage).toLowerCase();
            if (supportedLangs[userLang]) return userLang;
            const primaryLang = userLang.split('-')[0];
            if (supportedLangs[primaryLang]) return primaryLang;
            return 'en'; // Padrão para inglês
        }

        function setLanguage(langCode, priceText) {
            document.documentElement.lang = langCode;
            const dictionary = translations[langCode] || translations['en'];
            document.querySelectorAll('[data-i18n]').forEach(element => {
                const key = element.getAttribute('data-i18n');
                let text = dictionary[key] || `[${key}]`;
                if (key === 'subheadline') { text = text.replace('{price}', priceText).replace('{captureAction}', dictionary.captureAction).replace('{answerAction}', dictionary.answerAction); }
                if (element.tagName === 'TITLE' || element.tagName === 'STRONG') { element.textContent = text; } 
                else { element.innerHTML = text; }
            });
        }

        // --- FUNÇÃO PRINCIPAL ---
        function main() {
            try {
                const APP_PAGE = "/app.html";
                function getSessionId() { let sid = localStorage.getItem("mp_session_id"); if (!sid) { sid = crypto.randomUUID(); localStorage.setItem("mp_session_id", sid); } return sid; }
                function hasValidAccess() { const t = localStorage.getItem('accessToken'); if (!t) return false; try { return Date.now() < JSON.parse(t).expiry; } catch (e) { return false; } }
                function setAccessAndRedirect() { const expiry = Date.now() + 604800000; localStorage.setItem("accessToken", JSON.stringify({ expiry })); window.location.href = APP_PAGE; }

                if (hasValidAccess()) { window.location.href = APP_PAGE; return; }
                document.body.classList.remove('hidden-on-load');

                const supportedLanguages = { "pt-br": true, "en": true, "es": true, "it": true, "fr": true, "ru": true, "ja": true, "ko": true, "zh": true };
                const langCode = getLanguage(supportedLanguages);
                const currency = (langCode === 'pt-br') ? 'BRL' : 'USD';
                const dictionary = translations[langCode] || translations['en'];
                
                setLanguage(langCode, dictionary.price);

                document.getElementById('start-btn').addEventListener('click', async () => {
                    const btn = document.getElementById('start-btn');
                    btn.disabled = true;
                    btn.textContent = dictionary.loadingCheckout;
                    try {
                        const payload = { sessionId: getSessionId(), email: "cliente@email.com", currency };
                        const res = await fetch("/api/create-payment", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(payload) });
                        if (!res.ok) { const err = await res.json(); throw new Error(err.details || dictionary.checkoutError); }
                        const data = await res.json();
                        window.location.href = data.checkoutUrl;
                    } catch (error) { alert(error.message); btn.disabled = false; btn.textContent = dictionary.paymentButton; }
                });

                const urlParams = new URLSearchParams(window.location.search);
                if (urlParams.has('success')) {
                    const welcomeView = document.getElementById('welcome-view');
                    welcomeView.innerHTML = `<h2>${dictionary.paymentCheck}</h2>`;
                    let attempts = 0;
                    const checkInterval = setInterval(async () => {
                        if (++attempts > 10) { clearInterval(checkInterval); welcomeView.innerHTML = `<h2>${dictionary.paymentCheckError}</h2>`; return; }
                        try { const r = await fetch(`/api/check-status?sessionId=${getSessionId()}`); if (r.ok) { const j = await r.json(); if (j.paid) { clearInterval(checkInterval); setAccessAndRedirect(); } } } 
                        catch(e) { console.error("Erro na verificação, tentando novamente..."); }
                    }, 3000);
                }
            } catch (error) { console.error("Erro crítico:", error); document.body.innerHTML = `<div style="color: white; padding: 20px; text-align: center;"><h1>Error</h1><p>${error.message}</p></div>`; }
        }

        if (document.body) { main(); } else { document.addEventListener('DOMContentLoaded', main); }
    </script>
</body>
</html>
