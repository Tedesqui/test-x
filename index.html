<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pagamento - Acesso √† Ferramenta</title>
    <script src="https://sdk.mercadopago.com/js/v2"></script>
    <style>
        body, html { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: black; color: white; }
        .container { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; text-align: center; padding: 20px; box-sizing: border-box; }
        h2 { font-size: 1.8em; margin-bottom: 8px; }
        p { font-size: 1.1em; line-height: 1.5; max-width: 450px; }
        body.hidden { visibility: hidden; }

        .payment-choice-container { display: flex; flex-direction: column; gap: 15px; width: 100%; max-width: 320px; margin-top: 20px; }
        .choice-btn { background-color: #333; color: white; border: 1px solid #555; border-radius: 8px; padding: 18px; font-size: 1.1em; cursor: pointer; text-align: left; font-weight: bold; }
        .choice-btn:hover { background-color: #444; }

        .payment-area { display: none; width: 100%; max-width: 400px; margin-top: 15px; }
        
        #feedback-container { font-size: 1em; color: #ccc; margin-top: 25px; height: 20px; transition: color 0.3s; }
        .error-message { color: #ff9999; font-size: 0.9em; padding: 15px; border: 1px solid #555; border-radius: 4px; line-height: 1.4; text-align: left; }
        .back-btn { background: none; border: none; color: #009ee3; cursor: pointer; margin-top: 20px; font-size: 0.9em; }
    </style>
</head>
<body class="hidden">

    <div class="container">
        <h2>üîí Acesso Restrito √† Ferramenta de Corre√ß√£o</h2>
        <p>Para usar a ferramenta por <strong>1 hora</strong>, fa√ßa o pagamento de <strong>R$ 1,00</strong>.</p>

        <div id="payment-choice-container" class="payment-choice-container">
            <button id="show-card-btn" class="choice-btn">üí≥ Pagar com Cart√£o de Cr√©dito</button>
            <button id="show-pix-btn" class="choice-btn">‚ú® Pagar com Pix</button>
        </div>

        <div id="card-payment-area" class="payment-area">
            <div id="card-payment-container"></div>
            <button class="back-btn">‚Üê Escolher outra forma de pagamento</button>
        </div>

        <div id="pix-payment-area" class="payment-area">
            <div id="pix-payment-container"></div>
            <button class="back-btn">‚Üê Escolher outra forma de pagamento</button>
        </div>
        
        <div id="feedback-container"></div>
    </div>

    <script>
        const PUBLIC_KEY = "APP_USR-e86d8ca0-976c-468a-96ca-7e556120f5eb";
        const MP_SERVER_CREATE = "/api/create-payment";
        const MP_SERVER_PROCESS_CARD = "/api/process-card-payment";
        const MP_SERVER_CHECK_STATUS = "/api/check-status";
        const APP_PAGE = "app.html";

        const mp = new MercadoPago(PUBLIC_KEY, { locale: 'pt-BR' });
        const bricks = mp.bricks();
        
        // --- Seletores de Elementos ---
        const feedbackContainer = document.getElementById('feedback-container');
        const choiceContainer = document.getElementById('payment-choice-container');
        const cardArea = document.getElementById('card-payment-area');
        const pixArea = document.getElementById('pix-payment-area');
        const pixContainer = document.getElementById('pix-payment-container');

        let pixStatusInterval;
        let isCardBrickRendered = false;
        let isPixBrickRendered = false;

        // --- Fun√ß√µes de L√≥gica de Pagamento ---
        function getSessionId() {
            let sid = localStorage.getItem("mp_session_id");
            if (!sid) { sid = crypto.randomUUID(); localStorage.setItem("mp_session_id", sid); }
            return sid;
        }

        function handlePaymentSuccess() {
            if (pixStatusInterval) clearInterval(pixStatusInterval);
            feedbackContainer.style.color = '#28a745';
            feedbackContainer.textContent = "‚úÖ Pagamento aprovado! Redirecionando...";
            cardArea.style.display = 'none';
            pixArea.style.display = 'none';
            setTimeout(() => window.location.href = APP_PAGE, 1500);
        }

        function startPixPolling(sessionId) {
            if (pixStatusInterval) clearInterval(pixStatusInterval);
            pixStatusInterval = setInterval(async () => {
                try {
                    const r = await fetch(`${MP_SERVER_CHECK_STATUS}?sessionId=${sessionId}`);
                    if (r.ok) {
                        const j = await r.json();
                        if (j.paid) handlePaymentSuccess();
                    }
                } catch (e) { console.error("Polling Error:", e); clearInterval(pixStatusInterval); }
            }, 4000);
        }

        function renderCardBrick() {
            // ... (c√≥digo do cart√£o, que j√° est√° funcionando, permanece o mesmo) ...
        }

        /**
         * NOVO: Renderiza o Brick do Pix com um timeout para evitar espera infinita.
         */
        function renderPixWithTimeout(preferenceId) {
            return new Promise((resolve, reject) => {
                const timeoutId = setTimeout(() => {
                    reject(new Error("A gera√ß√£o do QR Code demorou demais. Isso geralmente indica um problema na prefer√™ncia criada pelo seu servidor (backend). Verifique se o valor √© maior que zero e se a sua conta MP pode receber por Pix."));
                }, 12000); // Timeout de 12 segundos

                bricks.create('pix', 'pix-payment-container', {
                    initialization: { preferenceId },
                    customization: { visual: { qrCodeSize: '240' } },
                    callbacks: {
                        onReady: () => {
                            clearTimeout(timeoutId);
                            isPixBrickRendered = true;
                            resolve();
                        },
                        onError: (error) => {
                            clearTimeout(timeoutId);
                            isPixBrickRendered = false;
                            reject(error);
                        },
                    },
                });
            });
        }
        
        // --- Fun√ß√µes de Controle da UI ---
        function showPaymentArea(areaToShow) {
            choiceContainer.style.display = 'none';
            cardArea.style.display = areaToShow === 'card' ? 'block' : 'none';
            pixArea.style.display = areaToShow === 'pix' ? 'block' : 'none';
        }

        function showChoiceArea() {
            if (pixStatusInterval) clearInterval(pixStatusInterval);
            feedbackContainer.textContent = '';
            choiceContainer.style.display = 'flex';
            cardArea.style.display = 'none';
            pixArea.style.display = 'none';
            pixContainer.innerHTML = '';
            isPixBrickRendered = false; 
        }

        // --- Fun√ß√£o Principal ---
        function main() {
            const hasAccess = localStorage.getItem('accessToken') && Date.now() < JSON.parse(localStorage.getItem('accessToken')).expiry;
            if (hasAccess) { window.location.href = APP_PAGE; return; }
            document.body.classList.remove('hidden');

            document.getElementById('show-card-btn').addEventListener('click', () => {
                showPaymentArea('card');
                if (!isCardBrickRendered) {
                    feedbackContainer.textContent = "Carregando formul√°rio...";
                    bricks.create('cardPayment', 'card-payment-container', {
                        initialization: { amount: 1.00 },
                        customization: { visual: { style: { theme: 'dark' } } },
                        callbacks: {
                            onReady: () => { feedbackContainer.textContent = "Preencha os dados do cart√£o."; isCardBrickRendered = true; },
                            onError: (error) => { console.error("Card Brick Error:", error); },
                            onSubmit: (cardFormData) => {
                                feedbackContainer.textContent = "Processando...";
                                return new Promise((resolve, reject) => {
                                    fetch(MP_SERVER_PROCESS_CARD, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ ...cardFormData, sessionId: getSessionId() }) })
                                    .then(res => res.json())
                                    .then(data => {
                                        if (data.status === 'approved') { handlePaymentSuccess(); resolve(); } 
                                        else { alert(data.message || "Pagamento recusado."); feedbackContainer.textContent = "Pagamento recusado."; reject(); }
                                    })
                                    .catch(() => { alert("Falha na comunica√ß√£o."); feedbackContainer.textContent = "Erro no pagamento."; reject(); });
                                });
                            },
                        },
                    });
                }
            });

            document.getElementById('show-pix-btn').addEventListener('click', async () => {
                showPaymentArea('pix');
                if (isPixBrickRendered) return;
                
                pixContainer.innerHTML = '';
                feedbackContainer.textContent = "Gerando c√≥digo Pix, aguarde...";
                feedbackContainer.style.color = '#ccc';

                try {
                    const sessionId = getSessionId();
                    const res = await fetch(MP_SERVER_CREATE, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ sessionId }) });
                    
                    if (!res.ok) throw new Error(`Seu servidor (/api/create-payment) respondeu com erro ${res.status}.`);
                    
                    const data = await res.json();

                    console.log("========================================================");
                    console.log("RESPOSTA DO SEU SERVIDOR /api/create-payment:");
                    console.log(JSON.stringify(data, null, 2));
                    console.log("========================================================");

                    if (!data.preferenceId) {
                        throw new Error("A resposta do seu servidor n√£o cont√©m um 'preferenceId'. Verifique o console (F12) para ver a resposta completa.");
                    }
                    
                    await renderPixWithTimeout(data.preferenceId);
                    
                    feedbackContainer.textContent = "Aponte a c√¢mera para o QR Code ou copie o c√≥digo.";
                    startPixPolling(sessionId);

                } catch (error) {
                    console.error("Falha ao iniciar Pix:", error);
                    feedbackContainer.style.color = '#ff9999';
                    feedbackContainer.textContent = "N√£o foi poss√≠vel gerar o Pix.";
                    pixContainer.innerHTML = `<p class='error-message'>${error.message}</p>`;
                }
            });

            document.querySelectorAll('.back-btn').forEach(btn => btn.addEventListener('click', showChoiceArea));
        }

        main();
    </script>
</body>
</html>
