<script>
    function main() {
        try {
            const APP_PAGE = "/app.html";
            function getSessionId() { let sid = localStorage.getItem("mp_session_id"); if (!sid) { sid = crypto.randomUUID(); localStorage.setItem("mp_session_id", sid); } return sid; }
            function hasValidAccess() { const t = localStorage.getItem('accessToken'); if (!t) return false; try { return Date.now() < JSON.parse(t).expiry; } catch (e) { return false; } }
            function setAccessAndRedirect() { const expiry = Date.now() + 604800000; localStorage.setItem("accessToken", JSON.stringify({ expiry })); window.location.href = APP_PAGE; }

            if (hasValidAccess()) {
                window.location.href = APP_PAGE;
                return;
            }

            document.body.classList.remove('hidden-on-load');

            // --- LÓGICA DE DETECÇÃO DE IDIOMA MAIS ROBUSTA ---
            const userLanguage = (navigator.language || navigator.userLanguage).toLowerCase();
            const isBrazilianPortuguese = userLanguage.startsWith('pt');
            const currency = isBrazilianPortuguese ? 'BRL' : 'USD';
            
            // --- Resto da lógica de tradução (sem alterações) ---
            const dictionary = translations[isBrazilianPortuguese ? 'pt-br' : 'en'] || translations['en'];
            setLanguage(userLanguage, currency, dictionary.price); // Você precisará da sua função setLanguage e do dictionary aqui

            document.getElementById('start-btn').addEventListener('click', async () => {
                const btn = document.getElementById('start-btn');
                btn.disabled = true;
                btn.textContent = 'Aguarde, gerando checkout...';
                const sessionId = getSessionId();

                try {
                    const payload = { sessionId, email: "cliente@email.com", currency };

                    // --- PONTO DE DEPURAÇÃO NO FRONTEND ---
                    console.log("Payload que será enviado para o backend:", payload);
                    alert(`DEPURAÇÃO: A moeda detectada e enviada é: ${currency}`);
                    // ----------------------------------------

                    const res = await fetch("/api/create-payment", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(payload) });
                    if (!res.ok) { const err = await res.json(); throw new Error(err.details || "Erro ao gerar link de pagamento."); }
                    const data = await res.json();
                    window.location.href = data.checkoutUrl;
                } catch (error) {
                    alert(error.message);
                    btn.disabled = false;
                    btn.textContent = 'CLIQUE AQUI PARA PAGAR';
                }
            });

            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('success')) {
                // Lógica de verificação de pagamento (sem alterações)
            }
        } catch (error) {
            // Lógica de erro (sem alterações)
        }
    }
    // Adicione seu objeto `translations` e a função `setLanguage` aqui antes de chamar `main()`
    // ...
    if(document.body) { main(); } else { document.addEventListener('DOMContentLoaded', main); }
</script>
