<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pagamento - Acesso √† Ferramenta</title>
    <script src="https://sdk.mercadopago.com/js/v2"></script>
    <style>
        body, html { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: black; color: white; }
        .container { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; text-align: center; padding: 20px; box-sizing: border-box; }
        h2 { font-size: 1.8em; margin-bottom: 8px; }
        p { font-size: 1.1em; line-height: 1.5; max-width: 450px; }
        body.hidden { visibility: hidden; }

        .payment-choice-container { display: flex; flex-direction: column; gap: 15px; width: 100%; max-width: 320px; margin-top: 20px; }
        .choice-btn { background-color: #333; color: white; border: 1px solid #555; border-radius: 8px; padding: 18px; font-size: 1.1em; cursor: pointer; text-align: left; font-weight: bold; }
        .choice-btn:hover { background-color: #444; }

        .payment-area { display: none; width: 100%; max-width: 400px; margin-top: 15px; }
        
        #feedback-container { font-size: 1em; color: #ccc; margin-top: 25px; height: 20px; transition: color 0.3s; }
        .error-message { color: #ff9999; font-size: 0.9em; padding: 15px; border: 1px solid #555; border-radius: 4px; line-height: 1.4; text-align: left; }
        .back-btn { background: none; border: none; color: #009ee3; cursor: pointer; margin-top: 20px; font-size: 0.9em; }

        /* Estilos para o novo formul√°rio PIX */
        .pix-form-input {
            width: 100%;
            padding: 12px;
            background-color: #222;
            border: 1px solid #555;
            color: white;
            border-radius: 6px;
            margin-bottom: 10px;
        }
        .pix-form-button {
            width: 100%;
            padding: 12px;
            background-color: #009ee3;
            color: white;
            border: none;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
        }
        .pix-form-button:hover { background-color: #00b1ff; }
        .pix-form-button:disabled { background-color: #555; cursor: not-allowed; }
    </style>
</head>
<body class="hidden">

    <div class="container">
        <h2>üîí Acesso Restrito √† Ferramenta de Corre√ß√£o</h2>
        <p>Para usar a ferramenta por <strong>1 hora</strong>, fa√ßa o pagamento de <strong>R$ 1,00</strong>.</p>

        <div id="payment-choice-container" class="payment-choice-container">
            <button id="show-card-btn" class="choice-btn">üí≥ Pagar com Cart√£o de Cr√©dito</button>
            <button id="show-pix-btn" class="choice-btn">‚ú® Pagar com Pix</button>
        </div>

        <div id="card-payment-area" class="payment-area">
            <div id="card-payment-container"></div>
            <button class="back-btn">‚Üê Escolher outra forma de pagamento</button>
        </div>

        <div id="pix-payment-area" class="payment-area">
            <form id="pix-email-form">
                <p class="text-sm mb-2">Informe seu e-mail para gerar o QR Code:</p>
                <input type="email" id="pix-payer-email" placeholder="seu.email@exemplo.com" required class="pix-form-input">
                <button type="submit" id="generate-pix-code-btn" class="pix-form-button">Gerar QR Code PIX</button>
            </form>
            
            <div id="pix-brick-container"></div>

            <button class="back-btn">‚Üê Escolher outra forma de pagamento</button>
        </div>
        
        <div id="feedback-container"></div>
    </div>

    <script>
        const PUBLIC_KEY = "APP_USR-e86d8ca0-976c-468a-96ca-7e556120f5eb"; // IMPORTANTE: Substitua pela sua chave
        const MP_SERVER_CREATE = "/api/create-payment"; // Rota para criar a prefer√™ncia
        const MP_SERVER_CHECK_STATUS = "/api/check-status";
        const APP_PAGE = "app.html";

        const mp = new MercadoPago(PUBLIC_KEY, { locale: 'pt-BR' });
        
        // --- Seletores de Elementos ---
        const feedbackContainer = document.getElementById('feedback-container');
        const choiceContainer = document.getElementById('payment-choice-container');
        const cardArea = document.getElementById('card-payment-area');
        const pixArea = document.getElementById('pix-payment-area');
        
        // Elementos do novo fluxo PIX
        const pixEmailForm = document.getElementById('pix-email-form');
        const pixPayerEmailInput = document.getElementById('pix-payer-email');
        const generatePixCodeBtn = document.getElementById('generate-pix-code-btn');
        const pixBrickContainer = document.getElementById('pix-brick-container');
        
        let pixStatusInterval;

        // --- Fun√ß√µes de L√≥gica de Pagamento ---
        function getSessionId() {
            let sid = localStorage.getItem("mp_session_id");
            if (!sid) { sid = crypto.randomUUID(); localStorage.setItem("mp_session_id", sid); }
            return sid;
        }

        function handlePaymentSuccess() {
            if (pixStatusInterval) clearInterval(pixStatusInterval);
            feedbackContainer.style.color = '#28a745';
            feedbackContainer.textContent = "‚úÖ Pagamento aprovado! Redirecionando...";
            choiceContainer.style.display = 'none';
            cardArea.style.display = 'none';
            pixArea.style.display = 'none';
            setTimeout(() => window.location.href = APP_PAGE, 1500);
        }

        function startPixPolling(sessionId) {
            if (pixStatusInterval) clearInterval(pixStatusInterval);
            pixStatusInterval = setInterval(async () => {
                try {
                    const r = await fetch(`${MP_SERVER_CHECK_STATUS}?sessionId=${sessionId}`);
                    if (r.ok) {
                        const j = await r.json();
                        if (j.paid) handlePaymentSuccess();
                    }
                } catch (e) { console.error("Polling Error:", e); clearInterval(pixStatusInterval); }
            }, 4000);
        }

        function renderPixBrick(preferenceId) {
            // Limpa o container e esconde o formul√°rio de email
            pixBrickContainer.innerHTML = '';
            pixEmailForm.style.display = 'none';

            return new Promise((resolve, reject) => {
                const timeoutId = setTimeout(() => {
                    reject(new Error("A gera√ß√£o do QR Code demorou demais."));
                }, 12000);

                mp.bricks().create('payment', 'pix-brick-container', {
                    initialization: {
                        amount: 1.00,
                        preferenceId: preferenceId,
                        payer: {
                            email: pixPayerEmailInput.value,
                        },
                    },
                    customization: {
                        paymentMethods: {
                            ticket: "all",
                            bankTransfer: "all",
                            creditCard: [], // Esconde cart√£o
                            debitCard: [],  // Esconde d√©bito
                            mercadoPago: [],// Esconde conta MP
                        },
                        visual: { style: { theme: 'dark' } }
                    },
                    callbacks: {
                        onReady: () => { clearTimeout(timeoutId); resolve(); },
                        onError: (error) => { clearTimeout(timeoutId); reject(error); },
                        onSubmit: () => { /* Acontece quando o usu√°rio paga e o modal fecha */ }
                    },
                });
            });
        }
        
        // --- Fun√ß√µes de Controle da UI ---
        function showPaymentArea(areaToShow) {
            choiceContainer.style.display = 'none';
            cardArea.style.display = areaToShow === 'card' ? 'block' : 'none';
            pixArea.style.display = areaToShow === 'pix' ? 'block' : 'none';
        }

        function showChoiceArea() {
            if (pixStatusInterval) clearInterval(pixStatusInterval);
            feedbackContainer.textContent = '';
            choiceContainer.style.display = 'flex';
            cardArea.style.display = 'none';
            pixArea.style.display = 'none';
            // Reseta o formul√°rio do PIX ao voltar
            pixEmailForm.style.display = 'block';
            pixBrickContainer.innerHTML = '';
        }

        // --- Fun√ß√£o Principal ---
        function main() {
            // L√≥gica de acesso (verifica√ß√£o se j√° tem token v√°lido)
            try {
                const accessToken = localStorage.getItem('accessToken');
                if (accessToken && Date.now() < JSON.parse(accessToken).expiry) {
                    window.location.href = APP_PAGE;
                    return;
                }
            } catch (e) { /* ignora erros de parsing */ }
            document.body.classList.remove('hidden');

            // L√≥gica do bot√£o de Cart√£o (simplificada, pois o foco √© o PIX)
            document.getElementById('show-card-btn').addEventListener('click', () => {
                alert("A op√ß√£o de Cart√£o de Cr√©dito est√° em manuten√ß√£o. Por favor, utilize o PIX.");
            });

            // L√≥gica do bot√£o de PIX (esconde op√ß√µes e mostra formul√°rio de email)
            document.getElementById('show-pix-btn').addEventListener('click', () => {
                showPaymentArea('pix');
            });

            // L√≥gica do novo formul√°rio do PIX
            pixEmailForm.addEventListener('submit', async (event) => {
                event.preventDefault();
                generatePixCodeBtn.disabled = true;
                feedbackContainer.textContent = "Gerando QR Code, aguarde...";
                feedbackContainer.style.color = '#ccc';
                
                try {
                    const sessionId = getSessionId();
                    const payerEmail = pixPayerEmailInput.value;

                    // Envia o e-mail para o backend para criar a prefer√™ncia
                    const res = await fetch(MP_SERVER_CREATE, { 
                        method: "POST", 
                        headers: { "Content-Type": "application/json" }, 
                        body: JSON.stringify({ sessionId, payerEmail }) // Envia o email
                    });
                    
                    if (!res.ok) throw new Error(`Seu servidor respondeu com um erro.`);
                    
                    const data = await res.json();
                    if (!data.preferenceId) throw new Error("A resposta do servidor n√£o cont√©m um 'preferenceId'.");

                    // Renderiza o Brick do Mercado Pago com a prefer√™ncia criada
                    await renderPixBrick(data.preferenceId);
                    
                    feedbackContainer.textContent = "Escaneie o QR Code para pagar.";
                    startPixPolling(sessionId); // Come√ßa a verificar se o pagamento foi feito

                } catch (error) {
                    console.error("Falha ao iniciar Pix:", error);
                    feedbackContainer.style.color = '#ff9999';
                    feedbackContainer.textContent = error.message;
                    generatePixCodeBtn.disabled = false;
                }
            });

            document.querySelectorAll('.back-btn').forEach(btn => btn.addEventListener('click', showChoiceArea));
        }

        main();
    </script>
</body>
</html>
