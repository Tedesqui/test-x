<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pagamento - Acesso √† Ferramenta</title>
    <script src="https://sdk.mercadopago.com/js/v2"></script>
    <style>
        body, html { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: black; color: white; }
        .container { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; text-align: center; padding: 20px; box-sizing: border-box; }
        h2 { font-size: 1.8em; margin-bottom: 8px; }
        p { font-size: 1.1em; line-height: 1.5; max-width: 450px; }
        body.hidden { visibility: hidden; }

        .tabs { display: flex; border-bottom: 1px solid #444; margin-bottom: 20px; margin-top: 15px; }
        .tab-button { background: none; border: none; color: #aaa; padding: 10px 18px; cursor: pointer; font-size: 1em; border-bottom: 2px solid transparent; }
        .tab-button.active { color: white; border-bottom: 2px solid #009ee3; }
        .tab-content { display: none; width: 100%; max-width: 380px; min-height: 300px; /* Aumentei a altura m√≠nima */ }
        .tab-content.active { display: block; }
        
        #feedback-container { font-size: 1em; color: #ccc; margin-top: 20px; height: 20px; transition: color 0.3s; }
        .error-message { color: #ff9999; font-size: 0.9em; padding: 10px; border: 1px solid #555; border-radius: 4px; }
    </style>
</head>
<body class="hidden">

    <div class="container">
        <h2>üîí Acesso Restrito √† Ferramenta de Corre√ß√£o</h2>
        <p>Para usar a ferramenta por <strong>1 hora</strong>, fa√ßa o pagamento de <strong>R$ 1,00</strong>.</p>

        <div class="tabs">
            <button class="tab-button active" data-tab="card">üí≥ Cart√£o de Cr√©dito</button>
            <button class="tab-button" data-tab="pix">Pix</button>
        </div>

        <div id="card" class="tab-content active">
            <div id="card-payment-container"></div>
        </div>
        <div id="pix" class="tab-content">
            <div id="pix-payment-container"></div>
        </div>

        <div id="feedback-container">Carregando op√ß√µes de pagamento...</div>
    </div>

    <script>
        const PUBLIC_KEY = "APP_USR-e86d8ca0-976c-468a-96ca-7e556120f5eb";
        const MP_SERVER_CREATE = "/api/create-payment";
        const MP_SERVER_PROCESS_CARD = "/api/process-card-payment";
        const MP_SERVER_CHECK_STATUS = "/api/check-status";
        const APP_PAGE = "app.html";

        // Fun√ß√µes de acesso e sess√£o (sem altera√ß√µes)
        function getSessionId() {
            let sid = localStorage.getItem("mp_session_id");
            if (!sid) { sid = crypto.randomUUID(); localStorage.setItem("mp_session_id", sid); }
            return sid;
        }
        function hasValidAccess() {
            const t = localStorage.getItem('accessToken');
            if (!t) return false;
            try { return Date.now() < JSON.parse(t).expiry; } catch (e) { return false; }
        }
        function setAccessAndRedirect() {
            const expiry = Date.now() + 3600 * 1000;
            localStorage.setItem("accessToken", JSON.stringify({ expiry, grantedAt: Date.now() }));
            window.location.href = APP_PAGE;
        }

        const mp = new MercadoPago(PUBLIC_KEY, { locale: 'pt-BR' });
        const bricks = mp.bricks();
        const feedbackContainer = document.getElementById('feedback-container');
        let pixStatusInterval;

        function handlePaymentSuccess() {
            if (pixStatusInterval) clearInterval(pixStatusInterval);
            feedbackContainer.style.color = '#28a745';
            feedbackContainer.textContent = "‚úÖ Pagamento aprovado! Redirecionando...";
            setTimeout(setAccessAndRedirect, 1500);
        }
        
        function startPixPolling() {
            if (pixStatusInterval) clearInterval(pixStatusInterval);
            const sessionId = getSessionId();
            pixStatusInterval = setInterval(async () => {
                try {
                    const r = await fetch(`${MP_SERVER_CHECK_STATUS}?sessionId=${sessionId}`);
                    if (r.ok) {
                        const j = await r.json();
                        if (j.paid) handlePaymentSuccess();
                    }
                } catch (e) {
                    console.error("Polling Error:", e);
                    clearInterval(pixStatusInterval);
                }
            }, 4000);
        }

        async function renderCardBrick() {
            const settings = {
                initialization: { amount: 1.00 },
                customization: { visual: { style: { theme: 'dark' } } },
                callbacks: {
                    onReady: () => {
                        if (document.getElementById('card').classList.contains('active')) {
                            feedbackContainer.textContent = "Preencha os dados do cart√£o.";
                        }
                    },
                    onError: (error) => console.error("Card Brick Error:", error),
                    onSubmit: (cardFormData) => {
                        feedbackContainer.textContent = "Processando seu pagamento...";
                        return new Promise((resolve, reject) => {
                            fetch(MP_SERVER_PROCESS_CARD, {
                                method: "POST",
                                headers: { "Content-Type": "application/json" },
                                body: JSON.stringify({ ...cardFormData, sessionId: getSessionId() }),
                            })
                            .then(response => response.json())
                            .then(data => {
                                if (data.status === 'approved') {
                                    handlePaymentSuccess();
                                    resolve();
                                } else {
                                    alert(data.message || "Pagamento recusado.");
                                    feedbackContainer.textContent = "Pagamento recusado. Tente novamente.";
                                    reject();
                                }
                            })
                            .catch(error => {
                                alert("Ocorreu uma falha na comunica√ß√£o. Tente novamente.");
                                feedbackContainer.textContent = "Erro no pagamento. Tente novamente.";
                                reject();
                            });
                        });
                    },
                },
            };
            return bricks.create('cardPayment', 'card-payment-container', settings);
        }

        async function renderPixBrick(preferenceId) {
            const pixContainer = document.getElementById('pix-payment-container');
            if (!preferenceId) {
                console.error("PIX Brick Falhou: preferenceId est√° ausente.");
                pixContainer.innerHTML = "<p class='error-message'>N√£o foi poss√≠vel carregar a op√ß√£o Pix. O servidor n√£o retornou um ID de pagamento. Verifique o backend.</p>";
                return;
            }
            const settings = {
                initialization: { preferenceId },
                customization: { visual: { qrCodeSize: '240' } },
                callbacks: {
                    onReady: () => {
                        if (document.getElementById('pix').classList.contains('active')) {
                            feedbackContainer.textContent = "Aponte a c√¢mera para o QR Code ou copie o c√≥digo.";
                        }
                        startPixPolling();
                    },
                    onError: (error) => {
                        console.error("PIX Brick Error:", error);
                        pixContainer.innerHTML = "<p class='error-message'>Ocorreu um erro ao gerar o c√≥digo Pix. Isso pode ser um problema com a prefer√™ncia de pagamento gerada pelo servidor. Tente usar o cart√£o de cr√©dito.</p>";
                    },
                },
            };
            return bricks.create('pix', 'pix-payment-container', settings);
        }

        async function main() {
            if (hasValidAccess()) { window.location.href = APP_PAGE; return; }
            document.body.classList.remove('hidden');

            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', () => {
                    document.querySelectorAll('.tab-button, .tab-content').forEach(el => el.classList.remove('active'));
                    button.classList.add('active');
                    document.getElementById(button.dataset.tab).classList.add('active');

                    // Define uma mensagem inicial gen√©rica ao trocar de aba
                    const activeBrickContainer = document.querySelector('.tab-content.active').firstElementChild;
                    if (activeBrickContainer.childElementCount > 0) {
                        feedbackContainer.textContent = button.dataset.tab === 'card'
                            ? "Preencha os dados do cart√£o."
                            : "Aponte a c√¢mera para o QR Code ou copie o c√≥digo.";
                    } else {
                         feedbackContainer.textContent = "Carregando...";
                    }
                });
            });

            try {
                // =======================================================================
                // IMPORTANTE: Verifique seu backend em /api/create-payment
                // Ele DEVE retornar um JSON como: { "preferenceId": "ID_GERADO_AQUI" }
                // A prefer√™ncia deve ter um item com valor (amount) maior que R$ 0.00.
                // =======================================================================
                console.log("Criando prefer√™ncia de pagamento...");
                const res = await fetch(MP_SERVER_CREATE, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ sessionId: getSessionId() })
                });

                if (!res.ok) {
                    throw new Error(`O servidor respondeu com erro ${res.status}.`);
                }

                const data = await res.json();
                console.log("Prefer√™ncia recebida:", data);

                if (!data.preferenceId) {
                    throw new Error("A resposta do servidor n√£o cont√©m um 'preferenceId'.");
                }

                // Renderiza os dois bricks, um ap√≥s o outro.
                await renderCardBrick();
                await renderPixBrick(data.preferenceId);
                
            } catch (error) {
                console.error("Falha Cr√≠tica no Fluxo de Pagamento:", error);
                feedbackContainer.style.color = '#ff9999';
                feedbackContainer.textContent = `Erro: ${error.message}`;
                // Exibe o erro nos dois containers
                document.getElementById('card-payment-container').innerHTML = `<p class='error-message'>Falha ao carregar pagamentos.</p>`;
                document.getElementById('pix-payment-container').innerHTML = `<p class='error-message'>Falha ao carregar pagamentos.</p>`;
            }
        }

        main();
    </script>
</body>
</html>
