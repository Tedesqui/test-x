<script>
    // Envolve toda a l√≥gica em um evento que espera a p√°gina carregar completamente.
    document.addEventListener('DOMContentLoaded', () => {
        
        // --- 1. L√ìGICA DE DETEC√á√ÉO DE IDIOMA E PRECIFICA√á√ÉO ---
        const userLanguage = navigator.language || navigator.userLanguage;
        let price, currency, displayText;

        if (userLanguage !== 'pt-BR') {
            price = 3.00;
            currency = 'USD';
            displayText = '$3.00 USD';
            document.title = "Get the answers for your test questions!";
        } else {
            price = 14.90;
            currency = 'BRL';
            displayText = 'R$ 14,90';
        }

        // --- 2. DEFINI√á√ÉO DAS FUN√á√ïES GLOBAIS ---
        const APP_PAGE = "/app.html";
        function getSessionId() { let sid = localStorage.getItem("mp_session_id"); if (!sid || sid.length < 10) { sid = crypto.randomUUID(); localStorage.setItem("mp_session_id", sid); } return sid; }
        function hasValidAccess() { const t = localStorage.getItem('accessToken'); if (!t) return false; try { return Date.now() < JSON.parse(t).expiry; } catch (e) { return false; } }
        function setAccessAndRedirect() { const expiry = Date.now() + 604800000; localStorage.setItem("accessToken", JSON.stringify({ expiry })); window.location.href = APP_PAGE; }
        function switchView(viewId) { document.querySelectorAll('.view').forEach(v => v.classList.remove('active')); document.getElementById(viewId).classList.add('active'); }

        // --- 3. FLUXO PRINCIPAL DA P√ÅGINA ---
        if (hasValidAccess()) {
            window.location.href = APP_PAGE;
            return; // Interrompe a execu√ß√£o se o usu√°rio j√° tem acesso
        }

        // Torna a p√°gina vis√≠vel
        document.body.classList.remove('hidden-on-load');

        // Seleciona os elementos do HTML AP√ìS garantir que a p√°gina carregou
        const welcomeViewH2 = document.querySelector("#welcome-view h2");
        const welcomeViewStrong = document.querySelector("#welcome-view strong");
        const welcomeViewP = document.querySelector("#welcome-view p");
        const startBtn = document.getElementById('start-btn');
        const pixForm = document.getElementById('pix-form');
        const pixEmailInput = document.getElementById('pix-email');
        const generatePixBtn = document.getElementById('generate-pix-btn');
        const pixQrCodeContainer = document.getElementById('pix-qr-code-container');
        const qrCodeImg = document.getElementById('pix-qr-code-image');
        const pixCopyPasteInput = document.getElementById('pix-copy-paste-code');
        const copyPixBtn = document.getElementById('copy-pix-btn');
        const pixStatusText = document.getElementById('pix-status-text');

        // Atualiza os textos na p√°gina
        if (welcomeViewH2) {
            welcomeViewH2.textContent = (currency === 'USD') ? 'üîí 1-Week Access to AI Proofreader' : 'üîí Acesso por 1 Semana √† Corre√ß√£o de Provas';
        }
        if (welcomeViewStrong) {
            welcomeViewStrong.textContent = displayText;
        }
        if (welcomeViewP) {
            welcomeViewP.innerHTML = (currency === 'USD')
                ? `Make the payment of <strong>${displayText}</strong> to unlock access. After payment, return to the site and grant camera permission. Point the camera at the questions, click on <strong>‚ÄúClick to Correct‚Äù</strong> and then on <strong>‚ÄúGet Answer‚Äù</strong>.`
                : `Realize o pagamento de <strong>${displayText}</strong> para liberar o acesso. Ap√≥s o pagamento, retorne e d√™ permiss√£o para o site usar sua c√¢mera. Aponte para as quest√µes, clique em <strong>‚ÄúClique para Corrigir‚Äù</strong> e em seguida em <strong>‚ÄúObter Resposta‚Äù</strong>.`;
        }

        // Adiciona os eventos
        startBtn.addEventListener('click', () => switchView('payment-view'));

        pixForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const email = pixEmailInput.value;
            if (!/^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/.test(String(email).toLowerCase())) {
                alert("Por favor, insira um endere√ßo de e-mail v√°lido."); return;
            }
            generatePixBtn.disabled = true;
            generatePixBtn.textContent = "Aguarde...";
            const sessionId = getSessionId();
            try {
                const payload = { sessionId, email, currency };
                const res = await fetch("/api/create-payment", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(payload) });
                if (!res.ok) { const err = await res.json(); throw new Error(err.details || "Erro ao gerar o PIX."); }
                const data = await res.json();
                qrCodeImg.src = `data:image/jpeg;base64,${data.qrCodeBase64}`;
                pixCopyPasteInput.value = data.qrCode;
                pixForm.classList.add('hidden');
                pixQrCodeContainer.classList.remove('hidden');
                const checkInterval = setInterval(async () => {
                    try {
                        const r = await fetch(`/api/check-status?sessionId=${sessionId}`);
                        if (r.ok) { const j = await r.json(); if (j.paid) { clearInterval(checkInterval); pixStatusText.textContent = "Pagamento Aprovado! Redirecionando..."; pixStatusText.classList.remove('animate-pulse'); setTimeout(setAccessAndRedirect, 1500); } }
                    } catch (e) { console.error("Erro na verifica√ß√£o de status:", e); clearInterval(checkInterval); }
                }, 4000);
            } catch (error) {
                alert(error.message);
                generatePixBtn.disabled = false;
                generatePixBtn.textContent = "Gerar QR Code PIX";
            }
        });

        copyPixBtn.addEventListener('click', () => {
            pixCopyPasteInput.select();
            document.execCommand('copy');
            copyPixBtn.textContent = 'Copiado!';
            setTimeout(() => { copyPixBtn.textContent = 'Copiar'; }, 2000);
        });
    });
</script>
