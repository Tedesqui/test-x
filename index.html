<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Acesso à Ferramenta de Correção com IA</title>
    <style>
        body, html { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: #121212; color: white; }
        .container { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; text-align: center; padding: 20px; box-sizing: border-box; }
        
        /* Estilos do View de Pagamento Inicial */
        #payment-view h2 { font-size: 1.8em; margin-bottom: 8px; }
        #payment-view p { font-size: 1.1em; line-height: 1.5; max-width: 400px; }
        #pay-btn { margin-top: 20px; padding: 16px 25px; font-size: 18px; border-radius: 8px; border: none; background: #009ee3; color: white; cursor: pointer; font-weight: bold; transition: background-color 0.2s; }
        #pay-btn:disabled { background: #555; cursor: wait; }
        #pay-btn:hover:not(:disabled) { background: #0089cc; }
        
        /* Estilos do View do PIX (aparece após clicar) */
        #pix-view { display: none; flex-direction: column; align-items: center; gap: 15px; background: #1e1e1e; padding: 25px; border-radius: 12px; max-width: 350px; border: 1px solid #333; }
        #pix-view h3 { margin: 0; font-size: 1.3em; }
        #qr-code-img { border: 6px solid white; border-radius: 8px; }
        #pix-copy-paste { font-family: 'Courier New', Courier, monospace; background: #2a2a2a; padding: 12px; border: 1px dashed #555; border-radius: 6px; word-break: break-all; font-size: 0.9em; cursor: pointer; position: relative; }
        #pix-copy-paste::after { content: 'Copiado!'; position: absolute; top: -28px; left: 50%; transform: translateX(-50%); background: #28a745; padding: 4px 8px; border-radius: 4px; font-family: sans-serif; font-size: 0.8em; opacity: 0; transition: opacity 0.3s; }
        #pix-copy-paste.copied::after { opacity: 1; }
        #pix-status { font-size: 1em; color: #ffc107; }

        body.hidden { display: none; }
    </style>
</head>
<body class="hidden">

    <div class="container">
        <div id="payment-view">
            <h2>🔒 Acesso Restrito à Ferramenta</h2>
            <p>Para utilizar a correção por IA durante <strong>1 hora</strong>, realize o pagamento único de <strong>R$ 1,00</strong> via PIX.</p>
            <button id="pay-btn">Pagar R$ 1,00 com PIX</button>
            <p style="font-size:0.8em;color:#888;margin-top:20px">Pagamento seguro processado pelo Mercado Pago.</p>
        </div>

        <div id="pix-view">
            <h3>Pague com PIX para liberar o acesso</h3>
            <img id="qr-code-img" src="" alt="QR Code PIX">
            <p>Clique no código abaixo para copiar:</p>
            <div id="pix-copy-paste" title="Clique para copiar"></div>
            <p id="pix-status">Aguardando pagamento...</p>
        </div>
    </div>

    <script>
        const MP_SERVER_CREATE = "/api/create-payment";
        const APP_PAGE = "app.html";

        // ===== LÓGICA DE ACESSO =====
        function getSessionId() {
            let sid = localStorage.getItem("mp_session_id");
            if (!sid || sid.length < 10) { // Garante que o ID não seja inválido/curto
                sid = crypto.randomUUID();
                localStorage.setItem("mp_session_id", sid);
            }
            return sid;
        }

        function hasValidAccess() {
            const tokenString = localStorage.getItem('accessToken');
            if (!tokenString) return false;
            try {
                const token = JSON.parse(tokenString);
                return Date.now() < token.expiry;
            } catch (e) { return false; }
        }

        function setAccessAndRedirect() {
            const expiry = Date.now() + (60 * 60 * 1000); // 1 hora
            localStorage.setItem("accessToken", JSON.stringify({ expiry }));
            window.location.href = APP_PAGE;
        }

        // ===== FLUXO DA PÁGINA =====
        if (hasValidAccess()) {
            window.location.href = APP_PAGE;
        } else {
            document.body.classList.remove('hidden');

            const payBtn = document.getElementById("pay-btn");
            const paymentView = document.getElementById("payment-view");
            const pixView = document.getElementById("pix-view");
            const qrCodeImg = document.getElementById("qr-code-img");
            const pixCopyPaste = document.getElementById("pix-copy-paste");

            // Evento para copiar o código PIX
            pixCopyPaste.addEventListener('click', () => {
                navigator.clipboard.writeText(pixCopyPaste.textContent);
                pixCopyPaste.classList.add('copied');
                setTimeout(() => pixCopyPaste.classList.remove('copied'), 2000);
            });

            // Evento principal para iniciar o pagamento
            payBtn.addEventListener("click", async () => {
                payBtn.disabled = true;
                payBtn.textContent = "Gerando PIX...";

                const sessionId = getSessionId();

                try {
                    const res = await fetch(MP_SERVER_CREATE, { 
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ sessionId })
                    });

                    if (!res.ok) {
                        const err = await res.json();
                        throw new Error(err.error || "Erro ao iniciar o processo de pagamento.");
                    }
                    
                    const data = await res.json();
                    
                    // Preenche os dados do PIX na tela
                    qrCodeImg.src = `data:image/jpeg;base64,${data.qrCodeBase64}`;
                    pixCopyPaste.textContent = data.qrCode;

                    // Esconde a view inicial e mostra a view do PIX
                    paymentView.style.display = 'none';
                    pixView.style.display = 'flex';

                    // Inicia a verificação de status em segundo plano
                    const checkInterval = setInterval(async () => {
                        try {
                            const r = await fetch(`/api/check-status?sessionId=${sessionId}`);
                            if (r.ok) {
                                const j = await r.json();
                                if (j.paid) {
                                    clearInterval(checkInterval);
                                    setAccessAndRedirect();
                                }
                            }
                        } catch (e) {
                            console.error("Erro na verificação de status:", e);
                            clearInterval(checkInterval); 
                        }
                    }, 4000); // Verifica a cada 4 segundos

                } catch (error) {
                    alert(error.message);
                    payBtn.disabled = false;
                    payBtn.textContent = "Pagar R$ 1,00 com PIX";
                }
            });
        }
    </script>
</body>
</html>
