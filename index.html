<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Acesso √† Ferramenta de Corre√ß√£o com IA</title>
    <style>
        body, html { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: #121212; color: white; }
        .container { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; text-align: center; padding: 20px; box-sizing: border-box; }
        
        /* View Gen√©rica */
        .view { display: none; flex-direction: column; align-items: center; width: 100%; max-width: 400px; }
        .view.active { display: flex; }

        h2 { font-size: 1.8em; margin-bottom: 8px; }
        p { font-size: 1.1em; line-height: 1.5; }
        .button { margin-top: 20px; padding: 16px 25px; font-size: 18px; border-radius: 8px; border: none; background: #009ee3; color: white; cursor: pointer; font-weight: bold; transition: background-color 0.2s; width: 100%; }
        .button:disabled { background: #555; cursor: wait; }
        .button:hover:not(:disabled) { background: #0089cc; }

        /* Estilos do View de Email */
        #email-input { width: 100%; padding: 15px; font-size: 16px; margin-top: 15px; border-radius: 8px; border: 1px solid #555; background: #2a2a2a; color: white; box-sizing: border-box; }
        #email-input:focus { outline: none; border-color: #009ee3; }

        /* Estilos do View do PIX (QR Code) */
        #pix-view-content { display: flex; flex-direction: column; align-items: center; gap: 15px; background: #1e1e1e; padding: 25px; border-radius: 12px; width: 100%; max-width: 350px; border: 1px solid #333; }
        #pix-view-content h3 { margin: 0; font-size: 1.3em; }
        
        /* AJUSTE DO TAMANHO DO QR CODE */
        #qr-code-img { 
            border: 6px solid white; 
            border-radius: 8px; 
            width: 100%; /* Ocupa 100% do container pai */
            max-width: 280px; /* Mas n√£o passa de 280px */
            height: auto; /* Mant√©m a propor√ß√£o */
        }

        #pix-copy-paste { font-family: 'Courier New', Courier, monospace; background: #2a2a2a; padding: 12px; border: 1px dashed #555; border-radius: 6px; word-break: break-all; font-size: 0.9em; cursor: pointer; position: relative; }
        #pix-copy-paste::after { content: 'Copiado!'; position: absolute; top: -28px; left: 50%; transform: translateX(-50%); background: #28a745; padding: 4px 8px; border-radius: 4px; font-family: sans-serif; font-size: 0.8em; opacity: 0; transition: opacity 0.3s; }
        #pix-copy-paste.copied::after { opacity: 1; }
        #pix-status { font-size: 1em; color: #ffc107; }

        body.hidden { display: none; }
    </style>
</head>
<body class="hidden">

    <div class="container">
        <div id="payment-view" class="view active">
            <h2>üîí Acesso Restrito √† Ferramenta</h2>
            <p>Para utilizar a corre√ß√£o por IA durante <strong>1 hora</strong>, insira seu e-mail para gerar o PIX de <strong>R$ 1,00</strong>.</p>
            <button id="continue-btn" class="button">Continuar</button>
            <p style="font-size:0.8em;color:#888;margin-top:20px">Pagamento seguro processado pelo Mercado Pago.</p>
        </div>

        <div id="email-view" class="view">
            <h2>Seu melhor e-mail</h2>
            <p>Usaremos este e-mail para identificar seu pagamento.</p>
            <input type="email" id="email-input" placeholder="seu.email@exemplo.com" class="button-like-input">
            <button id="generate-pix-btn" class="button">Gerar PIX</button>
        </div>

        <div id="pix-view" class="view">
            <div id="pix-view-content">
                <h3>Pague com PIX para liberar o acesso</h3>
                <img id="qr-code-img" src="" alt="QR Code PIX">
                <p style="font-size: 1em;">Clique no c√≥digo abaixo para copiar:</p>
                <div id="pix-copy-paste" title="Clique para copiar"></div>
                <p id="pix-status">Aguardando pagamento...</p>
            </div>
        </div>
    </div>

    <script>
        const MP_SERVER_CREATE = "/api/create-payment";
        const APP_PAGE = "app.html";

        function getSessionId() {
            let sid = localStorage.getItem("mp_session_id");
            if (!sid || sid.length < 10) {
                sid = crypto.randomUUID();
                localStorage.setItem("mp_session_id", sid);
            }
            return sid;
        }

        function hasValidAccess() {
            const tokenString = localStorage.getItem('accessToken');
            if (!tokenString) return false;
            try {
                const token = JSON.parse(tokenString);
                return Date.now() < token.expiry;
            } catch (e) { return false; }
        }

        function setAccessAndRedirect() {
            const expiry = Date.now() + (60 * 60 * 1000);
            localStorage.setItem("accessToken", JSON.stringify({ expiry }));
            window.location.href = APP_PAGE;
        }

        function switchView(viewId) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');
        }

        function validateEmail(email) {
            const re = /^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
            return re.test(String(email).toLowerCase());
        }

        if (hasValidAccess()) {
            window.location.href = APP_PAGE;
        } else {
            document.body.classList.remove('hidden');

            const continueBtn = document.getElementById("continue-btn");
            const generatePixBtn = document.getElementById("generate-pix-btn");
            const emailInput = document.getElementById("email-input");
            
            const qrCodeImg = document.getElementById("qr-code-img");
            const pixCopyPaste = document.getElementById("pix-copy-paste");

            // Fluxo 1: Da tela inicial para a tela de email
            continueBtn.addEventListener('click', () => {
                switchView('email-view');
                emailInput.focus();
            });

            // Fluxo 2: Copiar o c√≥digo PIX
            pixCopyPaste.addEventListener('click', () => {
                navigator.clipboard.writeText(pixCopyPaste.textContent);
                pixCopyPaste.classList.add('copied');
                setTimeout(() => pixCopyPaste.classList.remove('copied'), 2000);
            });

            // Fluxo 3: Gerar o PIX ap√≥s inserir o email
            generatePixBtn.addEventListener("click", async () => {
                const email = emailInput.value;
                if (!validateEmail(email)) {
                    alert("Por favor, insira um endere√ßo de e-mail v√°lido.");
                    return;
                }

                generatePixBtn.disabled = true;
                generatePixBtn.textContent = "Gerando PIX...";

                const sessionId = getSessionId();

                try {
                    const res = await fetch(MP_SERVER_CREATE, { 
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ sessionId, email }) // Enviando o email
                    });

                    if (!res.ok) {
                        const err = await res.json();
                        throw new Error(err.error || "Erro ao iniciar o processo de pagamento.");
                    }
                    
                    const data = await res.json();
                    
                    qrCodeImg.src = `data:image/jpeg;base64,${data.qrCodeBase64}`;
                    pixCopyPaste.textContent = data.qrCode;

                    switchView('pix-view');

                    // Inicia a verifica√ß√£o de status em segundo plano
                    const checkInterval = setInterval(async () => {
                        try {
                            const r = await fetch(`/api/check-status?sessionId=${sessionId}`);
                            if (r.ok) {
                                const j = await r.json();
                                if (j.paid) {
                                    clearInterval(checkInterval);
                                    setAccessAndRedirect();
                                }
                            }
                        } catch (e) {
                            console.error("Erro na verifica√ß√£o de status:", e);
                            clearInterval(checkInterval); 
                        }
                    }, 4000);

                } catch (error) {
                    alert(error.message);
                    generatePixBtn.disabled = false;
                    generatePixBtn.textContent = "Gerar PIX";
                }
            });
        }
    </script>
</body>
</html>
