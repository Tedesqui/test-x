<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pagamento - Acesso √† Ferramenta</title>
    <script src="https://sdk.mercadopago.com/js/v2"></script>
    <style>
        body, html { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: black; color: white; }
        .container { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; text-align: center; padding: 20px; box-sizing: border-box; }
        h2 { font-size: 1.8em; margin-bottom: 8px; }
        p { font-size: 1.1em; line-height: 1.5; max-width: 450px; }
        body.hidden { visibility: hidden; }

        .payment-choice-container { display: flex; flex-direction: column; gap: 15px; width: 100%; max-width: 320px; margin-top: 20px; }
        .choice-btn { background-color: #333; color: white; border: 1px solid #555; border-radius: 8px; padding: 18px; font-size: 1.1em; cursor: pointer; text-align: left; font-weight: bold; }
        .choice-btn:hover { background-color: #444; }

        .payment-area { display: none; width: 100%; max-width: 400px; margin-top: 15px; }
        
        #feedback-container { font-size: 1em; color: #ccc; margin-top: 25px; height: 20px; transition: color 0.3s; }
        .error-message { color: #ff9999; font-size: 0.9em; padding: 15px; border: 1px solid #555; border-radius: 4px; line-height: 1.4; text-align: left; }
        .back-btn { background: none; border: none; color: #009ee3; cursor: pointer; margin-top: 20px; font-size: 0.9em; }

        .pix-form-input { width: 100%; padding: 12px; background-color: #222; border: 1px solid #555; color: white; border-radius: 6px; margin-bottom: 10px; }
        .pix-form-button { width: 100%; padding: 12px; background-color: #009ee3; color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; }
        .pix-form-button:hover { background-color: #00b1ff; }
        .pix-form-button:disabled { background-color: #555; cursor: not-allowed; }
    </style>
</head>
<body class="hidden">

    <div class="container">
        <h2>üîí Acesso Restrito √† Ferramenta de Corre√ß√£o</h2>
        <p>Para usar a ferramenta por <strong>1 hora</strong>, fa√ßa o pagamento de <strong>R$ 1,00</strong>.</p>

        <div id="payment-choice-container" class="payment-choice-container">
            <button id="show-card-btn" class="choice-btn">üí≥ Pagar com Cart√£o de Cr√©dito</button>
            <button id="show-pix-btn" class="choice-btn">‚ú® Pagar com Pix</button>
        </div>

        <div id="card-payment-area" class="payment-area">
            <div id="card-payment-container"></div>
            <button class="back-btn">‚Üê Escolher outra forma de pagamento</button>
        </div>

        <div id="pix-payment-area" class="payment-area">
            <form id="pix-email-form">
                <p class="text-sm mb-2">Informe seu e-mail para gerar o QR Code:</p>
                <input type="email" id="pix-payer-email" placeholder="seu.email@exemplo.com" required class="pix-form-input">
                <button type="submit" id="generate-pix-code-btn" class="pix-form-button">Gerar QR Code PIX</button>
            </form>
            <div id="pix-brick-container"></div>
            <button class="back-btn">‚Üê Escolher outra forma de pagamento</button>
        </div>
        
        <div id="feedback-container"></div>
    </div>

    <script>
        const PUBLIC_KEY = "COLE_SUA_PUBLIC_KEY_DE_PRODU√á√ÉO_AQUI";
        const MP_SERVER_CREATE = "/api/create-payment";
        const MP_SERVER_CHECK_STATUS = "/api/check-status";
        const APP_PAGE = "app.html";

        const mp = new MercadoPago(PUBLIC_KEY, { locale: 'pt-BR' });
        
        // --- Seletores de Elementos ---
        const feedbackContainer = document.getElementById('feedback-container');
        const choiceContainer = document.getElementById('payment-choice-container');
        const cardArea = document.getElementById('card-payment-area');
        const pixArea = document.getElementById('pix-payment-area');
        const pixEmailForm = document.getElementById('pix-email-form');
        const pixPayerEmailInput = document.getElementById('pix-payer-email');
        const generatePixCodeBtn = document.getElementById('generate-pix-code-btn');
        const pixBrickContainer = document.getElementById('pix-brick-container');
        
        let paymentCheckInterval;

        function handlePaymentSuccess() {
            if (paymentCheckInterval) clearInterval(paymentCheckInterval);
            feedbackContainer.style.color = '#28a745';
            feedbackContainer.textContent = "‚úÖ Pagamento aprovado! Redirecionando...";
            
            // Cria o token de acesso e redireciona
            const expiry = Date.now() + 3600 * 1000; // 1 hora de acesso
            localStorage.setItem("accessToken", JSON.stringify({ expiry, grantedAt: Date.now() }));
            setTimeout(() => window.location.href = APP_PAGE, 1500);
        }

        // A fun√ß√£o de verifica√ß√£o agora recebe um ID de tentativa de pagamento
        function startPaymentStatusCheck(paymentAttemptId) {
            if (paymentCheckInterval) clearInterval(paymentCheckInterval);
            paymentCheckInterval = setInterval(async () => {
                try {
                    // Envia o ID da tentativa para o backend
                    const r = await fetch(`${MP_SERVER_CHECK_STATUS}?paymentAttemptId=${paymentAttemptId}`);
                    if (r.ok) {
                        const j = await r.json();
                        if (j.paid) handlePaymentSuccess();
                    }
                } catch (e) { console.error("Polling Error:", e); clearInterval(paymentCheckInterval); }
            }, 4000);
        }

        function renderPixBrick(preferenceId) {
            pixBrickContainer.innerHTML = '';
            pixEmailForm.style.display = 'none';

            return new Promise((resolve, reject) => {
                const timeoutId = setTimeout(() => reject(new Error("A gera√ß√£o do QR Code demorou demais.")), 12000);
                mp.bricks().create('payment', 'pix-brick-container', {
                    initialization: { amount: 1.00, preferenceId: preferenceId },
                    customization: { paymentMethods: { ticket: "all", bankTransfer: "all", creditCard: [], debitCard: [], mercadoPago: [] }, visual: { style: { theme: 'dark' } } },
                    callbacks: {
                        onReady: () => { clearTimeout(timeoutId); resolve(); },
                        onError: (error) => { clearTimeout(timeoutId); reject(error); }
                    },
                });
            });
        }
        
        function showPaymentArea(areaToShow) {
            choiceContainer.style.display = 'none';
            cardArea.style.display = areaToShow === 'card' ? 'block' : 'none';
            pixArea.style.display = areaToShow === 'pix' ? 'block' : 'none';
        }

        function showChoiceArea() {
            if (paymentCheckInterval) clearInterval(paymentCheckInterval);
            feedbackContainer.textContent = '';
            choiceContainer.style.display = 'flex';
            cardArea.style.display = 'none';
            pixArea.style.display = 'none';
            pixEmailForm.style.display = 'block';
            pixBrickContainer.innerHTML = '';
        }

        function main() {
            // Limpa o localStorage de sess√µes antigas para evitar o problema
            localStorage.removeItem("mp_session_id");

            try {
                const accessToken = localStorage.getItem('accessToken');
                if (accessToken && Date.now() < JSON.parse(accessToken).expiry) {
                    window.location.href = APP_PAGE; return;
                }
            } catch (e) { /* ignora */ }
            document.body.classList.remove('hidden');

            document.getElementById('show-card-btn').addEventListener('click', () => { alert("Op√ß√£o em manuten√ß√£o. Use o PIX."); });

            // L√≥gica do formul√°rio PIX
            pixEmailForm.addEventListener('submit', async (event) => {
                event.preventDefault();
                generatePixCodeBtn.disabled = true;
                feedbackContainer.textContent = "Gerando QR Code, aguarde...";
                
                try {
                    // GERA UM ID NOVO E √öNICO PARA CADA TENTATIVA
                    const paymentAttemptId = crypto.randomUUID();
                    const payerEmail = pixPayerEmailInput.value;

                    const res = await fetch(MP_SERVER_CREATE, { 
                        method: "POST", 
                        headers: { "Content-Type": "application/json" }, 
                        body: JSON.stringify({ paymentAttemptId, payerEmail }) // Envia o novo ID
                    });
                    
                    if (!res.ok) {
                        const errData = await res.json();
                        throw new Error(errData.message || 'Seu servidor respondeu com um erro.');
                    }
                    
                    const data = await res.json();
                    if (!data.preferenceId) throw new Error("A resposta do servidor n√£o cont√©m um 'preferenceId'.");

                    await renderPixBrick(data.preferenceId);
                    
                    feedbackContainer.textContent = "Escaneie o QR Code para pagar.";
                    startPaymentStatusCheck(paymentAttemptId);

                } catch (error) {
                    console.error("Falha ao iniciar Pix:", error);
                    feedbackContainer.style.color = '#ff9999';
                    feedbackContainer.textContent = error.message;
                    generatePixCodeBtn.disabled = false;
                }
            });

            document.querySelectorAll('.back-btn').forEach(btn => btn.addEventListener('click', showChoiceArea));
        }

        main();
    </script>
</body>
</html>
