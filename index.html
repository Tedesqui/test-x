<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Receba as respostas das quest√µes da sua prova!!!</title>
    <style>
        body, html { 
            margin: 0; 
            padding: 0; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background: #121212; 
            color: white; 
        }
        .hidden-on-load { 
            visibility: hidden; 
        }
        .container { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            min-height: 100vh; 
            text-align: center; 
            padding: 20px; 
            box-sizing: border-box; 
        }
        .view { 
            display: none; 
            flex-direction: column; 
            align-items: center; 
            width: 100%; 
            max-width: 420px; 
            margin-top: -250px; 
        }
        .view.active { 
            display: flex; 
        }
        #start-btn { 
            width: 100%; 
            color: white; 
            font-weight: bold; 
            font-size: 18px; 
            padding: 0.75rem 1rem; 
            border: none; 
            border-radius: 0.5rem; 
            cursor: pointer; 
            transition: background-color 0.2s; 
            margin-top: 1.5rem; 
            background-color: #22c55e; 
        }
        #start-btn:hover:not(:disabled) { 
            background-color: #16a34a; 
        }
        #start-btn:disabled {
            background-color: #555;
            cursor: wait;
        }
        .hidden { 
            display: none; 
        }
    </style>
</head>
<body class="hidden-on-load">
    <div class="container">
        <div id="welcome-view" class="view active">
            <h2>üîí Acesso por 1 Semana √† Corre√ß√£o de Provas</h2>
            <p style="font-size: 1.1em; line-height: 1.5;">Realize o pagamento de <strong>R$ 14,90</strong> para liberar o acesso. Ap√≥s o pagamento, retorne e d√™ permiss√£o para o site usar sua c√¢mera. Aponte para as quest√µes, clique em <strong>‚ÄúClique para Corrigir‚Äù</strong> e em seguida em <strong>‚ÄúObter Resposta‚Äù</strong>.</p>
            <button id="start-btn">CLIQUE AQUI PARA PAGAR</button>
        </div>
        </div>

    <script>
        function main() {
            try {
                // --- DEFINI√á√ÉO DE FUN√á√ïES ---
                const APP_PAGE = "/app.html";
                function getSessionId() { let sid = localStorage.getItem("mp_session_id"); if (!sid) { sid = crypto.randomUUID(); localStorage.setItem("mp_session_id", sid); } return sid; }
                function hasValidAccess() { const t = localStorage.getItem('accessToken'); if (!t) return false; try { return Date.now() < JSON.parse(t).expiry; } catch (e) { return false; } }
                function setAccessAndRedirect() { const expiry = Date.now() + 604800000; localStorage.setItem("accessToken", JSON.stringify({ expiry })); window.location.href = APP_PAGE; }

                // --- FLUXO PRINCIPAL ---
                if (hasValidAccess()) {
                    window.location.href = APP_PAGE;
                    return;
                }

                document.body.classList.remove('hidden-on-load');

                // L√≥gica de idioma e pre√ßo
                const userLanguage = navigator.language || navigator.userLanguage;
                let currency = 'BRL';
                let displayText = 'R$ 14,90';

                if (userLanguage !== 'pt-BR') {
                    currency = 'USD';
                    displayText = '$3.00 USD';
                    document.title = "Get the answers for your test questions!";
                }

                document.querySelector("#welcome-view h2").textContent = (currency === 'USD') ? 'üîí 1-Week Access to AI Proofreader' : 'üîí Acesso por 1 Semana √† Corre√ß√£o de Provas';
                document.querySelector("#welcome-view strong").textContent = displayText;
                document.querySelector("#welcome-view p").innerHTML = (currency === 'USD')
                    ? `Make the payment of <strong>${displayText}</strong> to unlock access. After payment, return to the site and grant camera permission. Point the camera at the questions, click on <strong>‚ÄúClick to Correct‚Äù</strong> and then on <strong>‚ÄúGet Answer‚Äù</strong>.`
                    : `Realize o pagamento de <strong>${displayText}</strong> para liberar o acesso. Ap√≥s o pagamento, retorne e d√™ permiss√£o para o site usar sua c√¢mera. Aponte para as quest√µes, clique em <strong>‚ÄúClique para Corrigir‚Äù</strong> e em seguida em <strong>‚ÄúObter Resposta‚Äù</strong>.`;
                
                // L√≥gica do bot√£o de pagamento
                document.getElementById('start-btn').addEventListener('click', async () => {
                    const btn = document.getElementById('start-btn');
                    btn.disabled = true;
                    btn.textContent = 'Aguarde, gerando checkout...';

                    // O email n√£o √© mais necess√°rio aqui, pois ser√° solicitado na p√°gina do Asaas
                    const email = "cliente@email.com"; // Usamos um placeholder
                    const sessionId = getSessionId();

                    try {
                        const payload = { sessionId, email, currency };
                        const res = await fetch("/api/create-payment", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(payload) });
                        
                        if (!res.ok) {
                            const err = await res.json();
                            throw new Error(err.details || "Erro ao gerar link de pagamento.");
                        }

                        const data = await res.json();
                        
                        // Redireciona o usu√°rio para a p√°gina de pagamento do Asaas
                        window.location.href = data.checkoutUrl;

                    } catch (error) {
                        alert(error.message);
                        btn.disabled = false;
                        btn.textContent = 'CLIQUE AQUI PARA PAGAR';
                    }
                });

                // L√≥gica para verificar o pagamento quando o usu√°rio RETORNA do Asaas
                const urlParams = new URLSearchParams(window.location.search);
                const paymentSuccess = urlParams.has('success'); // Asaas redireciona para a successUrl que definimos
                const sessionIdOnReturn = getSessionId();

                if (paymentSuccess && sessionIdOnReturn) {
                    const welcomeView = document.getElementById('welcome-view');
                    welcomeView.innerHTML = '<h2>Verificando seu pagamento, aguarde um instante...</h2>';
                    
                    let attempts = 0;
                    const maxAttempts = 10; // Tenta por 30 segundos no m√°ximo

                    const checkInterval = setInterval(async () => {
                        attempts++;
                        if (attempts > maxAttempts) {
                            clearInterval(checkInterval);
                            welcomeView.innerHTML = '<h2>Ocorreu um problema ao verificar seu pagamento. Por favor, recarregue a p√°gina.</h2>';
                            return;
                        }

                        try {
                            const r = await fetch(`/api/check-status?sessionId=${sessionIdOnReturn}`);
                            if (r.ok) {
                                const j = await r.json();
                                if (j.paid) {
                                    clearInterval(checkInterval);
                                    setAccessAndRedirect();
                                }
                            }
                        } catch(e) {
                            // ignora erros de fetch e tenta novamente
                            console.error("Erro na verifica√ß√£o, tentando novamente...");
                        }
                    }, 3000); // Verifica a cada 3 segundos
                }

            } catch (error) {
                console.error("Ocorreu um erro cr√≠tico:", error);
                document.body.classList.remove('hidden-on-load');
                document.body.innerHTML = `<div style="color: white; padding: 20px; text-align: center;"><h1>Erro ao carregar</h1><p>${error.message}</p></div>`;
            }
        }

        // Movemos a execu√ß√£o para garantir que o body exista
        if(document.body) {
            main();
        } else {
            document.addEventListener('DOMContentLoaded', main);
        }
    </script>
</body>
</html>
