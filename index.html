<script>
    // PASSO 1: TORNAR A P√ÅGINA VIS√çVEL IMEDIATAMENTE.
    // Isso garante que, aconte√ßa o que acontecer no resto do script, voc√™ n√£o ver√° mais uma tela preta.
    document.body.classList.remove('hidden-on-load');

    // PASSO 2: Envolver toda a l√≥gica em um bloco `try...catch` para capturar qualquer erro.
    try {

        // --- DEFINI√á√ÉO DE FUN√á√ïES ---
        const APP_PAGE = "/app.html";
        function getSessionId() { let sid = localStorage.getItem("mp_session_id"); if (!sid || sid.length < 10) { sid = crypto.randomUUID(); localStorage.setItem("mp_session_id", sid); } return sid; }
        function hasValidAccess() { const t = localStorage.getItem('accessToken'); if (!t) return false; try { return Date.now() < JSON.parse(t).expiry; } catch (e) { return false; } }
        function setAccessAndRedirect() { const expiry = Date.now() + 604800000; localStorage.setItem("accessToken", JSON.stringify({ expiry })); window.location.href = APP_PAGE; }
        function switchView(viewId) { document.querySelectorAll('.view').forEach(v => v.classList.remove('active')); document.getElementById(viewId).classList.add('active'); }

        // --- FLUXO PRINCIPAL ---
        if (hasValidAccess()) {
            window.location.href = APP_PAGE;
        } else {
            // L√≥gica de idioma e pre√ßo
            const userLanguage = navigator.language || navigator.userLanguage;
            let currency = 'BRL';
            let displayText = 'R$ 14,90';

            if (userLanguage !== 'pt-BR') {
                currency = 'USD';
                displayText = '$3.00 USD';
                document.title = "Get the answers for your test questions!";
            }
            
            // Atualiza os textos da p√°gina
            document.querySelector("#welcome-view h2").textContent = (currency === 'USD') ? 'üîí 1-Week Access to AI Proofreader' : 'üîí Acesso por 1 Semana √† Corre√ß√£o de Provas';
            document.querySelector("#welcome-view strong").textContent = displayText;
            document.querySelector("#welcome-view p").innerHTML = (currency === 'USD')
                ? `Make the payment of <strong>${displayText}</strong> to unlock access. After payment, return to the site and grant camera permission. Point the camera at the questions, click on <strong>‚ÄúClick to Correct‚Äù</strong> and then on <strong>‚ÄúGet Answer‚Äù</strong>.`
                : `Realize o pagamento de <strong>${displayText}</strong> para liberar o acesso. Ap√≥s o pagamento, retorne e d√™ permiss√£o para o site usar sua c√¢mera. Aponte para as quest√µes, clique em <strong>‚ÄúClique para Corrigir‚Äù</strong> e em seguida em <strong>‚ÄúObter Resposta‚Äù</strong>.`;

            // Configura√ß√£o dos eventos
            document.getElementById('start-btn').addEventListener('click', () => switchView('payment-view'));

            document.getElementById('pix-form').addEventListener('submit', async (event) => {
                event.preventDefault();
                const email = document.getElementById('pix-email').value;
                if (!/^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/.test(String(email).toLowerCase())) {
                    alert("Por favor, insira um endere√ßo de e-mail v√°lido."); return;
                }
                const generatePixBtn = document.getElementById('generate-pix-btn');
                generatePixBtn.disabled = true;
                generatePixBtn.textContent = "Aguarde...";
                const sessionId = getSessionId();
                try {
                    const payload = { sessionId, email, currency };
                    const res = await fetch("/api/create-payment", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(payload) });
                    if (!res.ok) { const err = await res.json(); throw new Error(err.details || "Erro ao gerar o PIX."); }
                    const data = await res.json();
                    document.getElementById('pix-qr-code-image').src = `data:image/jpeg;base64,${data.qrCodeBase64}`;
                    document.getElementById('pix-copy-paste-code').value = data.qrCode;
                    document.getElementById('pix-form').classList.add('hidden');
                    document.getElementById('pix-qr-code-container').classList.remove('hidden');
                    const pixStatusText = document.getElementById('pix-status-text');
                    const checkInterval = setInterval(async () => {
                        try {
                            const r = await fetch(`/api/check-status?sessionId=${sessionId}`);
                            if (r.ok) { const j = await r.json(); if (j.paid) { clearInterval(checkInterval); pixStatusText.textContent = "Pagamento Aprovado! Redirecionando..."; pixStatusText.classList.remove('animate-pulse'); setTimeout(setAccessAndRedirect, 1500); } }
                        } catch (e) { console.error("Erro na verifica√ß√£o de status:", e); clearInterval(checkInterval); }
                    }, 4000);
                } catch (error) {
                    alert(error.message);
                    generatePixBtn.disabled = false;
                    generatePixBtn.textContent = "Gerar QR Code PIX";
                }
            });

            document.getElementById('copy-pix-btn').addEventListener('click', () => {
                const copyPixBtn = document.getElementById('copy-pix-btn');
                const pixCopyPasteInput = document.getElementById('pix-copy-paste-code');
                pixCopyPasteInput.select();
                document.execCommand('copy');
                copyPixBtn.textContent = 'Copiado!';
                setTimeout(() => { copyPixBtn.textContent = 'Copiar'; }, 2000);
            });
        }

    } catch (error) {
        // PASSO 3: Se qualquer coisa dentro do `try` falhar, este bloco ser√° executado.
        console.error("Ocorreu um erro cr√≠tico na inicializa√ß√£o da p√°gina:", error);
        alert("Ocorreu um erro ao carregar os componentes da p√°gina. Verifique o console para mais detalhes.");
        // Isso tamb√©m vai garantir que a p√°gina fique vis√≠vel, mesmo com o erro,
        // para que possamos depurar.
        document.body.innerHTML = `<div style="color: white; padding: 20px; text-align: center;"><h1>Erro ao carregar</h1><p>Ocorreu um erro no script da p√°gina. Verifique o console do desenvolvedor (F12) para mais detalhes. Erro: ${error.message}</p></div>`;
    }
</script>
