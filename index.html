<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pagamento - Acesso √† Ferramenta</title>
    <script src="https://sdk.mercadopago.com/js/v2"></script>
    <style>
        body, html { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: black; color: white; }
        .container { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; text-align: center; padding: 20px; box-sizing: border-box; }
        h2 { font-size: 1.8em; margin-bottom: 8px; }
        p { font-size: 1.1em; line-height: 1.5; max-width: 450px; }
        body.hidden { visibility: hidden; }

        .tabs { display: flex; border-bottom: 1px solid #444; margin-bottom: 20px; margin-top: 15px; }
        .tab-button { background: none; border: none; color: #aaa; padding: 10px 18px; cursor: pointer; font-size: 1em; border-bottom: 2px solid transparent; }
        .tab-button.active { color: white; border-bottom: 2px solid #009ee3; }
        .tab-content { display: none; width: 100%; max-width: 380px; min-height: 250px; }
        .tab-content.active { display: block; }
        
        #feedback-container { font-size: 1em; color: #ccc; margin-top: 20px; height: 20px; transition: color 0.3s; }
    </style>
</head>
<body class="hidden">

    <div class="container">
        <h2>üîí Acesso Restrito √† Ferramenta de Corre√ß√£o</h2>
        <p>Para usar a ferramenta por <strong>1 hora</strong>, fa√ßa o pagamento de <strong>R$ 1,00</strong>.</p>

        <div class="tabs">
            <button class="tab-button active" data-tab="card">üí≥ Cart√£o de Cr√©dito</button>
            <button class="tab-button" data-tab="pix">Pix</button>
        </div>

        <div id="card" class="tab-content active">
            <div id="card-payment-container"></div>
        </div>
        <div id="pix" class="tab-content">
            <div id="pix-payment-container"></div>
        </div>

        <div id="feedback-container">Carregando op√ß√µes de pagamento...</div>
    </div>

    <script>
        const PUBLIC_KEY = "APP_USR-e86d8ca0-976c-468a-96ca-7e556120f5eb";
        const MP_SERVER_CREATE = "/api/create-payment";
        const MP_SERVER_PROCESS_CARD = "/api/process-card-payment";
        const MP_SERVER_CHECK_STATUS = "/api/check-status";
        const APP_PAGE = "app.html";

        function getSessionId() {
            let sid = localStorage.getItem("mp_session_id");
            if (!sid) { sid = crypto.randomUUID(); localStorage.setItem("mp_session_id", sid); }
            return sid;
        }

        function hasValidAccess() {
            const t = localStorage.getItem('accessToken');
            if (!t) return false;
            try { return Date.now() < JSON.parse(t).expiry; } catch (e) { return false; }
        }

        function setAccessAndRedirect() {
            const expiry = Date.now() + 3600 * 1000;
            localStorage.setItem("accessToken", JSON.stringify({ expiry, grantedAt: Date.now() }));
            window.location.href = APP_PAGE;
        }

        const mp = new MercadoPago(PUBLIC_KEY, { locale: 'pt-BR' });
        const bricks = mp.bricks();
        const feedbackContainer = document.getElementById('feedback-container');
        let pixStatusInterval;

        function handlePaymentSuccess() {
            if (pixStatusInterval) clearInterval(pixStatusInterval);
            feedbackContainer.style.color = '#28a745';
            feedbackContainer.textContent = "‚úÖ Pagamento aprovado! Redirecionando...";
            setTimeout(setAccessAndRedirect, 1500);
        }
        
        function startPixPolling() {
            if (pixStatusInterval) clearInterval(pixStatusInterval);
            const sessionId = getSessionId();
            pixStatusInterval = setInterval(async () => {
                try {
                    const r = await fetch(`${MP_SERVER_CHECK_STATUS}?sessionId=${sessionId}`);
                    if (r.ok) {
                        const j = await r.json();
                        if (j.paid) handlePaymentSuccess();
                    }
                } catch (e) {
                    console.error("Polling Error:", e);
                    clearInterval(pixStatusInterval);
                }
            }, 4000);
        }

        async function renderCardBrick() {
            const settings = {
                initialization: { amount: 1.00 },
                customization: { visual: { style: { theme: 'dark' } } },
                callbacks: {
                    onReady: () => {
                        feedbackContainer.textContent = "Preencha os dados do cart√£o.";
                    },
                    onError: (error) => {
                        console.error("Card Brick Error:", error);
                        feedbackContainer.textContent = "Erro ao carregar o formul√°rio de cart√£o.";
                    },
                    onSubmit: (cardFormData) => {
                        feedbackContainer.textContent = "Processando seu pagamento...";
                        return new Promise((resolve, reject) => {
                            fetch(MP_SERVER_PROCESS_CARD, {
                                method: "POST",
                                headers: { "Content-Type": "application/json" },
                                body: JSON.stringify({ ...cardFormData, sessionId: getSessionId() }),
                            })
                            .then(response => response.json())
                            .then(data => {
                                if (data.status === 'approved') {
                                    handlePaymentSuccess();
                                    resolve();
                                } else {
                                    alert(data.message || "Pagamento recusado. Verifique seus dados.");
                                    feedbackContainer.textContent = "Pagamento recusado. Tente novamente.";
                                    reject();
                                }
                            })
                            .catch(error => {
                                console.error("Process Card Error:", error);
                                alert("Ocorreu uma falha na comunica√ß√£o. Tente novamente.");
                                feedbackContainer.textContent = "Erro no pagamento. Tente novamente.";
                                reject();
                            });
                        });
                    },
                },
            };
            return bricks.create('cardPayment', 'card-payment-container', settings);
        }

        async function renderPixBrick(preferenceId) {
            if (!preferenceId) {
                console.error("PIX Brick: preferenceId is missing.");
                document.getElementById('pix-payment-container').innerHTML = "<p style='color: #ff9999;'>Erro: N√£o foi poss√≠vel obter o ID de pagamento para o Pix.</p>";
                return;
            }
            const settings = {
                initialization: { preferenceId },
                customization: { visual: { qrCodeSize: '220' } },
                callbacks: {
                    onReady: () => {
                        startPixPolling();
                    },
                    onError: (error) => {
                        console.error("PIX Brick Error:", error);
                        document.getElementById('pix-payment-container').innerHTML = "<p style='color: #ff9999;'>Ocorreu um erro ao gerar o c√≥digo Pix. Tente usar o cart√£o.</p>";
                    },
                },
            };
            return bricks.create('pix', 'pix-payment-container', settings);
        }

        async function main() {
            if (hasValidAccess()) { window.location.href = APP_PAGE; return; }

            const params = new URLSearchParams(window.location.search);
            if (params.get("payment_status") === "success") { setAccessAndRedirect(); return; }

            document.body.classList.remove('hidden');

            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', () => {
                    document.querySelectorAll('.tab-button, .tab-content').forEach(el => el.classList.remove('active'));
                    button.classList.add('active');
                    const activeTab = document.getElementById(button.dataset.tab);
                    activeTab.classList.add('active');
                    feedbackContainer.textContent = activeTab.id === 'card'
                        ? "Preencha os dados do cart√£o."
                        : "Aponte a c√¢mera para o QR Code ou copie o c√≥digo.";
                });
            });

            try {
                const res = await fetch(MP_SERVER_CREATE, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ sessionId: getSessionId() })
                });
                if (!res.ok) throw new Error("Falha ao criar prefer√™ncia de pagamento.");
                const data = await res.json();
                
                await renderCardBrick();
                await renderPixBrick(data.preferenceId);
                
            } catch (error) {
                console.error("Main flow error:", error);
                feedbackContainer.style.color = '#ff9999';
                feedbackContainer.textContent = `Erro ao carregar pagamentos: ${error.message}`;
            }
        }

        main();
    </script>
</body>
</html>
