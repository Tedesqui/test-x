<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="pageTitle">Receba as respostas das quest√µes da sua prova!!!</title>
    <style>
        body, html { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: #121212; color: white; }
        .hidden-on-load { visibility: hidden; }
        .container { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; text-align: center; padding: 20px; box-sizing: border-box; }
        .view { display: none; flex-direction: column; align-items: center; width: 100%; max-width: 420px; margin-top: -250px; }
        .view.active { display: flex; }
        #start-btn { width: 100%; color: white; font-weight: bold; font-size: 18px; padding: 0.75rem 1rem; border: none; border-radius: 0.5rem; cursor: pointer; transition: background-color 0.2s; margin-top: 1.5rem; background-color: #22c55e; }
        #start-btn:hover:not(:disabled) { background-color: #16a34a; }
        #start-btn:disabled { background-color: #555; cursor: wait; }
    </style>
</head>
<body class="hidden-on-load">
    <div class="container">
        <div id="welcome-view" class="view active">
            <h2 data-i18n="headline">üîí Acesso por 1 Semana √† Corre√ß√£o de Provas</h2>
            <p data-i18n="subheadline" style="font-size: 1.1em; line-height: 1.5;">Realize o pagamento de <strong data-i18n="price">R$ 14,90</strong> para liberar o acesso...</p>
            <button id="start-btn" data-i18n="paymentButton">CLIQUE AQUI PARA PAGAR</button>
        </div>
    </div>

    <script>
        // --- DICION√ÅRIO DE TRADU√á√ïES (i18n) COMPLETO ---
        const translations = {
            "pt-br": { pageTitle: "Receba as respostas das quest√µes da sua prova!!!", headline: "üîí Acesso por 1 Semana √† Corre√ß√£o de Provas", subheadline: 'Realize o pagamento de <strong>{price}</strong> para liberar o acesso. Ap√≥s o pagamento, retorne e d√™ permiss√£o para o site usar sua c√¢mera. Aponte para as quest√µes, clique em <strong>{captureAction}</strong> e em seguida em <strong>{answerAction}</strong>.', price: 'R$ 14,90', captureAction: '‚ÄúClique para Corrigir‚Äù', answerAction: '‚ÄúObter Resposta‚Äù', paymentButton: "CLIQUE AQUI PARA PAGAR", loadingCheckout: "Aguarde, gerando checkout...", checkoutError: "Erro ao gerar link de pagamento.", paymentCheck: "Pagamento aprovado! Redirecionando...", paymentCheckError: "Ocorreu um problema ao verificar seu pagamento. Por favor, recarregue a p√°gina." },
            "en": { pageTitle: "Get Answers for Your Test Questions!", headline: "üîí 1-Week Access to AI Proofreader", subheadline: 'Make the payment of <strong>{price}</strong> to unlock access. After payment, return to the site and grant camera permission. Point the camera at the questions, click on <strong>{captureAction}</strong> and then on <strong>{answerAction}</strong>.', price: '$3.00 USD', captureAction: '‚ÄúClick to Correct‚Äù', answerAction: '‚ÄúGet Answer‚Äù', paymentButton: "CLICK HERE TO PAY", loadingCheckout: "Please wait, generating checkout...", checkoutError: "Error generating payment link.", paymentCheck: "Payment approved! Redirecting...", paymentCheckError: "There was a problem verifying your payment. Please reload the page." },
            // ... (outras tradu√ß√µes que voc√™ j√° tinha)
        };

        function getLanguageCode() {
            const supportedLangs = ["pt-br", "en", "es", "it", "fr", "ru", "ja", "ko", "zh"];
            const userLang = (navigator.language || navigator.userLanguage).toLowerCase();
            if (supportedLangs.includes(userLang)) return userLang;
            const primaryLang = userLang.split('-')[0];
            if (supportedLangs.includes(primaryLang)) return primaryLang;
            return 'en';
        }

        function setLanguage(langCode) {
            document.documentElement.lang = langCode;
            const dictionary = translations[langCode] || translations['en'];
            const priceText = dictionary.price;
            document.querySelectorAll('[data-i18n]').forEach(element => {
                const key = element.getAttribute('data-i18n');
                let text = dictionary[key] || `[${key}]`;
                if (key === 'subheadline') { text = text.replace('{price}', priceText).replace('{captureAction}', dictionary.captureAction).replace('{answerAction}', dictionary.answerAction); }
                if (element.tagName === 'TITLE' || element.tagName === 'STRONG') { element.textContent = text; } 
                else { element.innerHTML = text; }
            });
        }
        
        function main() {
            try {
                document.body.classList.remove('hidden-on-load');
                
                const APP_PAGE = "/app.html";
                function getSessionId() { let sid = localStorage.getItem("mp_session_id"); if (!sid) { sid = crypto.randomUUID(); localStorage.setItem("mp_session_id", sid); } return sid; }
                function hasValidAccess() { const t = localStorage.getItem('accessToken'); if (!t) return false; try { return Date.now() < JSON.parse(t).expiry; } catch (e) { return false; } }
                function setAccessAndRedirect() { const expiry = Date.now() + 604800000; localStorage.setItem("accessToken", JSON.stringify({ expiry })); window.location.href = APP_PAGE; }

                if (hasValidAccess()) {
                    window.location.href = APP_PAGE;
                    return;
                }

                const langCode = getLanguageCode();
                const currency = (langCode === 'pt-br') ? 'BRL' : 'USD';
                const dictionary = translations[langCode] || translations['en'];
                
                setLanguage(langCode);

                // L√≥gica para verificar o pagamento quando o usu√°rio RETORNA do Stripe
                const urlParams = new URLSearchParams(window.location.search);
                const stripeSessionId = urlParams.get('session_id');

                if (stripeSessionId) {
                    // Se o Stripe nos redirecionou de volta com um ID de sess√£o, o pagamento foi bem-sucedido.
                    const welcomeView = document.getElementById('welcome-view');
                    welcomeView.innerHTML = `<h2>${dictionary.paymentCheck}</h2>`;
                    // N√£o precisamos verificar novamente, apenas liberamos o acesso.
                    setTimeout(setAccessAndRedirect, 1500);
                } else {
                    // Se n√£o h√° ID de sess√£o, mostramos o bot√£o de pagamento normal.
                    document.getElementById('start-btn').addEventListener('click', async () => {
                        const btn = document.getElementById('start-btn');
                        btn.disabled = true;
                        btn.textContent = dictionary.loadingCheckout;
                        
                        // O email agora ser√° preenchido na p√°gina do Stripe
                        const payload = { sessionId: getSessionId(), email: "user@example.com", currency };

                        try {
                            const res = await fetch("/api/create-payment", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(payload) });
                            if (!res.ok) { const err = await res.json(); throw new Error(err.details || dictionary.checkoutError); }
                            const data = await res.json();
                            // Redireciona para a p√°gina de checkout do Stripe
                            window.location.href = data.checkoutUrl;
                        } catch (error) {
                            alert(error.message);
                            btn.disabled = false;
                            btn.textContent = dictionary.paymentButton;
                        }
                    });
                }
            } catch (error) {
                console.error("Erro cr√≠tico:", error);
                document.body.innerHTML = `<div style="color: white; padding: 20px; text-align: center;"><h1>Error</h1><p>${error.message}</p></div>`;
            }
        }

        main();
    </script>
</body>
</html>
